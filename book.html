<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›¹ì†Œì„¤ ë¦¬ë” - ë‚´ ì„œì¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }

        .font-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-serif-kr { font-family: 'Noto Serif KR', serif; }

        /* í…Œë§ˆ ì •ì˜ */
        .theme-white { --bg-color: #ffffff; --text-color: #111827; }
        .theme-sepia { --bg-color: #f6f1e3; --text-color: #5f4b32; } 
        .theme-dark { --bg-color: #374151; --text-color: #e5e7eb; }
        .theme-mint { --bg-color: #e0f2f1; --text-color: #004d40; }
        .theme-black { --bg-color: #000000; --text-color: #9ca3af; }

        /* ë·°ì–´ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #viewer-screen {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            transition: background-color 0.3s, color 0.3s;
        }

        .viewer-content p {
            color: inherit !important; 
            margin-bottom: 1.2em;
            min-height: 1em;
            word-break: keep-all;
            text-align: justify;
        }
        
        /* ì±•í„° ì œëª© ìŠ¤íƒ€ì¼ (ë·°ì–´ ë‚´ë¶€) */
        .chapter-title {
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 2em;
            margin-bottom: 1em;
            padding-bottom: 0.5em;
            border-bottom: 1px solid currentColor;
            opacity: 0.8;
        }
        
        .viewer-header-gradient {
            background: linear-gradient(to bottom, var(--bg-color), transparent);
        }

        /* ì±… ì»¤ë²„ ìŠ¤íƒ€ì¼ */
        .book-cover-1 { background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); }
        .book-cover-2 { background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); }
        .book-cover-3 { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .book-cover-4 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .book-cover-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .book-card { transition: transform 0.2s, box-shadow 0.2s; }
        .book-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        
        .folder-card { background: #fefce8; border: 1px solid #fde047; }
        .folder-card:hover { background: #fef9c3; }

        #settings-panel, #toc-panel { transition: transform 0.3s ease-in-out; }
        .panel-hidden { transform: translateY(100%); }
        .panel-visible { transform: translateY(0); }
        
        /* ëª©ì°¨ ì‚¬ì´ë“œë°” (ì™¼ìª½) */
        #toc-sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toc-hidden { transform: translateX(-100%); }
        .toc-visible { transform: translateX(0); }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #reader { width: 100%; border-radius: 0.5rem; overflow: hidden; }
        .code-input { letter-spacing: 0.5em; text-align: center; font-size: 1.5rem; font-family: monospace; }
        
        .nav-btn {
            background-color: rgba(0,0,0,0.05); padding: 1rem; border-radius: 0.5rem; text-align: center; font-weight: bold; transition: background-color 0.2s; cursor: pointer;
        }
        .nav-btn:hover { background-color: rgba(0,0,0,0.1); }

        .fab-btn {
            width: 3rem; height: 3rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, background-color 0.2s; backdrop-filter: blur(4px);
        }
        .fab-btn:active { transform: scale(0.95); }
        .rotate-45 { transform: rotate(45deg); }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans-kr overflow-hidden text-gray-800 touch-pan-y">

    <!-- 1. ì„œì¬ í™”ë©´ (Library) -->
    <div id="library-screen" class="flex-1 flex flex-col h-full bg-gray-50 text-gray-800 overflow-hidden">
        <!-- ê¸°ì¡´ í—¤ë” ìœ ì§€ -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center shadow-sm z-10 gap-4">
            <div class="flex items-center justify-between w-full md:w-auto gap-4">
                <div class="flex items-center gap-2">
                    <button id="back-to-root-btn" onclick="goToRoot()" class="hidden mr-2 p-2 rounded-full hover:bg-gray-100 text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <div>
                        <h1 id="library-title" class="text-2xl font-bold text-gray-800">ë‚´ ì„œì¬</h1>
                        <p id="library-subtitle" class="text-xs text-gray-500 mt-1">ì €ì¥ëœ ì†Œì„¤ ëª©ë¡</p>
                    </div>
                    <div class="flex items-center gap-1 ml-2">
                        <button onclick="openSyncModal()" class="text-gray-400 hover:text-blue-600 transition-colors p-2 rounded-full hover:bg-gray-100" title="ë°ì´í„° ê´€ë¦¬"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg></button>
                        <button onclick="openCreateCollectionModal()" class="text-gray-400 hover:text-yellow-500 transition-colors p-2 rounded-full hover:bg-gray-100" title="ìƒˆ í´ë” ë§Œë“¤ê¸°"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg></button>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                <div class="relative">
                    <button onclick="toggleDownloadMenu()" class="flex items-center gap-1 px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-600 hover:bg-gray-200 transition-colors" title="ë‚´ë³´ë‚´ê¸°">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                    <div id="download-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 z-30 py-1">
                        <button onclick="downloadAsZip()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><span class="text-blue-500">ğŸ“¦</span> ì¼ê´„ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
                        <button onclick="downloadAsMerged()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><span class="text-green-500">ğŸ“‘</span> í•˜ë‚˜ë¡œ í•©ì¹˜ê¸° (TXT)</button>
                    </div>
                </div>
                <button onclick="cycleSort()" id="sort-btn" class="flex items-center gap-1 px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-600 hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>
                    <span id="sort-label">ìµœì‹ ìˆœ</span>
                </button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button onclick="openWriteModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg><span class="hidden sm:inline">ê¸€ì“°ê¸°</span></button>
                <button onclick="openUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg><span class="hidden sm:inline">ì—…ë¡œë“œ</span></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6" id="library-container">
            <div id="book-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-7xl mx-auto"></div>
            <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 space-y-4 pb-20">
                <div class="text-6xl">ğŸ“‚</div><p class="text-lg">í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p><p class="text-sm">ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œì„¤ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
            </div>
        </main>
    </div>

    <!-- 2. ë·°ì–´ í™”ë©´ (Viewer) -->
    <div id="viewer-screen" class="hidden fixed inset-0 z-50 flex flex-col theme-sepia">
        <div class="absolute top-0 left-0 w-full h-1 bg-current/10 z-50">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-150" style="width: 0%"></div>
        </div>

        <header class="viewer-header-gradient absolute top-0 w-full p-4 flex justify-between items-center z-40 h-20 transition-opacity duration-300 opacity-0 hover:opacity-100">
            <div class="flex items-center gap-2">
                <button onclick="goBack()" class="flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    <span class="hidden sm:inline">ë‚˜ê°€ê¸°</span>
                </button>
                <!-- ëª©ì°¨ ë²„íŠ¼ (NEW) -->
                <button onclick="toggleTOC()" class="flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                    </svg>
                    <span class="hidden sm:inline">ëª©ì°¨</span>
                </button>
            </div>
            
            <h2 id="viewer-title" class="text-lg font-bold truncate max-w-[40%] text-center px-4 drop-shadow-md">ì œëª©</h2>
            
            <button onclick="shareNovel()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
            </button>
        </header>

        <main id="content-container" class="h-full overflow-y-auto px-4 pb-32 pt-16 md:px-0 scroll-smooth">
            <div id="content-inner" class="viewer-content max-w-3xl mx-auto text-lg leading-relaxed outline-none min-h-screen" tabindex="0">
                <!-- í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜ì—­ -->
            </div>
            <div class="max-w-3xl mx-auto mt-16 mb-20 px-2">
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-prev-chap" class="nav-btn" onclick="moveToNeighbor(-1)">â† ì´ì „ ì†Œì„¤</button>
                    <button id="btn-next-chap" class="nav-btn" onclick="moveToNeighbor(1)">ë‹¤ìŒ ì†Œì„¤ â†’</button>
                </div>
            </div>
        </main>

        <!-- ëª©ì°¨ ì‚¬ì´ë“œë°” (NEW) -->
        <div id="toc-dim" onclick="toggleTOC()" class="fixed inset-0 bg-black/50 z-[60] hidden opacity-0 transition-opacity"></div>
        <aside id="toc-sidebar" class="fixed top-0 left-0 w-[80%] max-w-xs h-full bg-[var(--bg-color)] shadow-2xl z-[70] toc-hidden flex flex-col border-r border-current/10">
            <div class="p-4 border-b border-current/10 flex justify-between items-center">
                <h3 class="font-bold text-lg opacity-80">ëª©ì°¨</h3>
                <button onclick="toggleTOC()" class="opacity-50 hover:opacity-100 text-2xl">âœ•</button>
            </div>
            <div id="toc-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- ëª©ì°¨ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
            </div>
        </aside>

        <!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
        <div class="absolute bottom-6 right-6 z-50 flex flex-col gap-3 items-center">
            <button onclick="scrollToTop()" class="fab-btn bg-gray-100 text-gray-600 hover:bg-gray-200" title="ë§¨ ìœ„ë¡œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg></button>
            <button onclick="scrollToBottom()" class="fab-btn bg-gray-100 text-gray-600 hover:bg-gray-200" title="ë§¨ ì•„ë˜ë¡œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg></button>
            <button id="settings-toggle-btn" onclick="toggleSettings()" class="fab-btn bg-blue-600 text-white hover:bg-blue-700 shadow-lg" title="ì„¤ì •">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform duration-300" id="settings-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute opacity-0 transform transition-all duration-300" id="close-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ -->
        <div id="settings-panel" class="absolute bottom-0 left-0 w-full bg-[var(--bg-color)] border-t border-current/10 p-6 z-40 panel-hidden shadow-2xl rounded-t-2xl">
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="w-12 h-1 bg-current/20 rounded-full mx-auto mb-2 cursor-pointer" onclick="toggleSettings()"></div>
                <div class="space-y-2">
                    <label class="text-sm font-bold opacity-70">ë°°ê²½ í…Œë§ˆ</label>
                    <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setTheme('theme-white')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-white flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-sepia')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#f6f1e3] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-mint')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#e0f2f1] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-dark')" class="w-10 h-10 rounded-full border border-gray-600 shadow-sm bg-[#374151] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-black')" class="w-10 h-10 rounded-full border border-gray-700 shadow-sm bg-[#000000] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">ê¸€ê¼´</label>
                        <div class="flex bg-current/5 rounded-lg p-1">
                            <button onclick="setFont('sans')" id="btn-font-sans" class="flex-1 py-2 rounded-md text-sm font-sans-kr transition-colors">ê³ ë”•</button>
                            <button onclick="setFont('serif')" id="btn-font-serif" class="flex-1 py-2 rounded-md text-sm font-serif-kr transition-colors">ëª…ì¡°</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">í¬ê¸° ë° ê°„ê²©</label>
                        <div class="flex items-center space-x-3">
                            <button onclick="adjustSize(-1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">-</button>
                            <span id="font-size-display" class="font-mono text-sm w-8 text-center"></span>
                            <button onclick="adjustSize(1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">+</button>
                            <div class="h-4 w-px bg-current/20 mx-1"></div>
                            <button onclick="adjustLineHeight(-0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ì¢ê²Œ</button>
                            <button onclick="adjustLineHeight(0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ë„“ê²Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- P2P ëª¨ë‹¬ ë“± (ê¸°ì¡´ ìœ ì§€) -->
    <div id="sync-modal" class="fixed inset-0 bg-black/50 z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative flex flex-col max-h-[90vh] overflow-y-auto">
            <button onclick="closeSyncModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">âœ•</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">ë°ì´í„° ê´€ë¦¬ ë° ë™ê¸°í™”</h3>
            <div id="sync-main-view" class="space-y-6">
                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wider">ğŸ“¡ ê¸°ê¸° ê°„ ì§ì ‘ ì „ì†¡ (P2P)</h4>
                    <div class="space-y-3">
                        <button onclick="startHostMode()" class="w-full bg-blue-50 hover:bg-blue-100 border border-blue-200 text-blue-700 p-4 rounded-xl flex items-center justify-between group transition-colors">
                            <div class="text-left"><div class="font-bold">ğŸ“¤ ë³´ë‚´ê¸° (Host)</div><div class="text-xs opacity-70">ì¼íšŒìš© ì½”ë“œ/QRë¡œ ì „ì†¡</div></div>
                        </button>
                        <button onclick="startClientMode()" class="w-full bg-green-50 hover:bg-green-100 border border-green-200 text-green-700 p-4 rounded-xl flex items-center justify-between group transition-colors">
                            <div class="text-left"><div class="font-bold">ğŸ“¥ ë°›ê¸° (Client)</div><div class="text-xs opacity-70">ì½”ë“œ ì…ë ¥/QR ìŠ¤ìº”</div></div>
                        </button>
                    </div>
                </div>
                <hr class="border-gray-200">
                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wider">ğŸ’¾ íŒŒì¼ ë°±ì—… ë° ë³µì›</h4>
                    <div class="space-y-3">
                        <button onclick="exportAllData()" class="w-full bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 p-3 rounded-lg flex items-center justify-center gap-2 font-medium text-sm">
                            ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (.json)
                        </button>
                        <div class="relative">
                            <input type="file" id="backup-input" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importFromFile(this)">
                            <button class="w-full bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 p-3 rounded-lg flex items-center justify-center gap-2 font-medium text-sm">
                                ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (.json)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sync-host-view" class="hidden flex flex-col items-center text-center space-y-4">
                <p class="text-sm text-gray-600">ë°›ëŠ” ê¸°ê¸°ì— ì•„ë˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                <div class="bg-gray-50 border-2 border-dashed border-blue-300 rounded-xl p-4 w-full">
                     <p class="text-xs text-gray-500 mb-1">ì¼íšŒìš© ì—°ê²° ì½”ë“œ</p>
                     <div id="host-code-display" class="text-4xl font-mono font-bold tracking-widest text-blue-600 select-all">-----</div>
                </div>
                <div id="qrcode-container" class="bg-white p-2 rounded-lg border shadow-sm"></div>
                <button onclick="resetSyncView()" class="text-gray-500 text-sm hover:underline mt-2">ë’¤ë¡œ ê°€ê¸°</button>
            </div>
            <div id="sync-client-view" class="hidden flex flex-col space-y-4">
                <div id="manual-input-container" class="space-y-4">
                    <input type="number" id="target-peer-id" placeholder="12345" class="code-input w-full border-2 border-gray-300 rounded-xl p-3 outline-none focus:border-blue-500 focus:bg-blue-50 transition-colors" maxlength="5">
                    <button onclick="connectToPeer()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">ì—°ê²°í•˜ê¸°</button>
                   <button onclick="startScanner()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200 flex items-center justify-center gap-2">ì¹´ë©”ë¼ ì¼œê¸°</button>
                </div>
                <div id="qr-reader-container" class="hidden">
                    <div id="reader" class="bg-black"></div>
                    <button onclick="stopScanner()" class="w-full mt-2 py-2 bg-gray-200 rounded text-sm font-medium">ì¹´ë©”ë¼ ë„ê¸°</button>
                </div>
                <button onclick="resetSyncView()" class="text-gray-500 text-sm hover:underline text-center mt-2">ë’¤ë¡œ ê°€ê¸°</button>
            </div>
            <div id="sync-status" class="mt-4 text-center hidden">
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-bold animate-pulse">
                    <span id="sync-status-text">ìƒíƒœ ë©”ì‹œì§€</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ê¸°íƒ€ ëª¨ë‹¬ (ê¸°ì¡´ ìœ ì§€) -->
    <div id="upload-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">ìƒˆ ì†Œì„¤ ì¶”ê°€</h3>
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer relative">
                <input type="file" id="file-input" accept=".txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="text-4xl mb-2">ğŸ“‚</div><p class="text-gray-600 font-medium">TXT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p><p id="selected-filename" class="text-blue-600 text-sm mt-2 hidden"></p>
            </div>
            <div class="mt-4 flex items-center gap-2 text-sm text-gray-600 justify-center"><label>ì¸ì½”ë”©:</label><select id="encoding-select" class="border rounded px-2 py-1"><option value="utf-8">UTF-8 (ê¸°ë³¸)</option><option value="euc-kr">EUC-KR (ê¹¨ì§ ë°©ì§€)</option></select></div>
            <div class="mt-6 flex justify-end gap-3"><button onclick="closeUploadModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button><button onclick="processUpload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">ì¶”ê°€í•˜ê¸°</button></div>
        </div>
    </div>
    <div id="write-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col p-6 shadow-2xl relative">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800">ì†Œì„¤ ì“°ê¸°</h3><button onclick="closeWriteModal()" class="text-gray-400 hover:text-gray-600">âœ•</button></div>
            <div class="flex-1 flex flex-col gap-4 overflow-hidden"><input type="text" id="write-title" placeholder="ì œëª©" class="w-full text-lg font-bold p-3 border-b-2 border-gray-200 outline-none"><textarea id="write-content" placeholder="ë‚´ìš©..." class="w-full flex-1 p-3 resize-none outline-none text-base leading-relaxed overflow-y-auto"></textarea></div>
            <div class="mt-4 flex justify-end gap-3"><button onclick="closeWriteModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button><button onclick="saveWrittenNovel()" class="px-6 py-2 bg-green-600 text-white rounded-lg shadow-sm font-bold">ì €ì¥í•˜ê¸°</button></div>
        </div>
    </div>
    <div id="create-collection-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative"><h3 class="text-lg font-bold mb-4">ìƒˆ í´ë”</h3><input type="text" id="new-collection-name" placeholder="ì´ë¦„" class="w-full border-2 border-gray-200 rounded-xl p-3 outline-none focus:border-yellow-400 mb-4"><div class="flex justify-end gap-2"><button onclick="closeCreateCollectionModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button><button onclick="createCollection()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg">ë§Œë“¤ê¸°</button></div></div>
    </div>
    <div id="move-book-modal" class="fixed inset-0 bg-black/50 z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative flex flex-col max-h-[80vh]"><h3 class="text-lg font-bold mb-4">ì´ë™í•  í´ë”</h3><div id="move-collection-list" class="flex-1 overflow-y-auto space-y-2"></div><div class="mt-4 flex justify-end"><button onclick="closeMoveBookModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button></div></div>
    </div>
    <div id="loader-overlay" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center space-y-4"><div class="loader"></div><p id="loader-text" class="text-gray-800 font-medium">ì²˜ë¦¬ ì¤‘...</p></div>
    </div>

    <script>
        const DB_NAME = 'WebNovelLibrary';
        const DB_VERSION = 3;
        let db;
        let currentBookId = null;
        let currentBookData = null;
        let currentCollectionId = null;
        let movingBookId = null;
        let currentSort = { field: 'lastRead', order: 'desc' };
        let settings = { theme: 'theme-sepia', fontSize: 20, lineHeight: 1.8, fontFamily: 'sans' };
        let peer = null; let conn = null; let html5QrCode = null;
        let bookTOC = []; // ëª©ì°¨ ë°ì´í„°

        async function init() {
            loadSettings();
            await initDB();
            window.addEventListener('hashchange', handleHashChange);
            handleHashChange();
            document.getElementById('file-input').addEventListener('change', function() {
                if(this.files[0]) { document.getElementById('selected-filename').textContent = this.files[0].name; document.getElementById('selected-filename').classList.remove('hidden'); }
            });
            document.getElementById('content-container').addEventListener('scroll', throttle(() => { updateProgress(); if(currentBookId) saveScrollPosition(); }, 1000));
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('download-menu');
                const btn = document.querySelector('button[onclick="toggleDownloadMenu()"]');
                if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden');
            });
        }

        // --- ëª©ì°¨ ìë™ ìƒì„± ë° ê´€ë¦¬ (NEW) ---
        function generateTOC(text) {
            const lines = text.split(/\r?\n/);
            const toc = [];
            // ëª©ì°¨ ì •ê·œì‹ íŒ¨í„´ (í•©ë³¸ êµ¬ë¶„ì, ní™”, ì±•í„°, ì„œë§‰ ë“±)
            const patterns = [
                /^={5,}\s+(.+?)\s+={5,}$/, // í•©ë³¸ êµ¬ë¶„ì (ìµœìš°ì„ )
                /^ì œ\s?(\d+)\s?[í™”ì¥]/, 
                /^(Chapter|Ep)\.?\s?\d+/i,
                /^\d+í™”$/, 
                /^\[.+\]$/,
                /^\d+\.\s/
            ];

            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed || trimmed.length > 50) return; // ë„ˆë¬´ ê¸´ ì¤„ì€ ì œëª© ì•„ë‹˜

                for (let pattern of patterns) {
                    if (pattern.test(trimmed)) {
                        // ì œëª© ì •ì œ
                        let title = trimmed.replace(/^={5,}\s+|={5,}$/g, '');
                        toc.push({ title: title, lineIndex: index });
                        break; 
                    }
                }
            });
            return toc;
        }

        function toggleTOC() {
            const sidebar = document.getElementById('toc-sidebar');
            const dim = document.getElementById('toc-dim');
            const isHidden = sidebar.classList.contains('toc-hidden');
            
            if (isHidden) {
                sidebar.classList.remove('toc-hidden');
                sidebar.classList.add('toc-visible');
                dim.classList.remove('hidden');
                setTimeout(()=>dim.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('toc-hidden');
                sidebar.classList.remove('toc-visible');
                dim.classList.add('opacity-0');
                setTimeout(()=>dim.classList.add('hidden'), 300);
            }
        }

        function renderTOC() {
            const list = document.getElementById('toc-list');
            list.innerHTML = '';
            
            if (bookTOC.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-sm opacity-50">ê°ì§€ëœ ëª©ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            bookTOC.forEach((chapter, idx) => {
                const item = document.createElement('div');
                item.className = 'p-3 hover:bg-current/5 cursor-pointer text-sm border-b border-current/5 truncate transition-colors';
                item.textContent = chapter.title;
                item.onclick = () => {
                    toggleTOC(); // ë‹«ê¸°
                    const targetElement = document.getElementById(`chapter-${idx}`);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        // fallback (ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŒ)
                        alert('ìœ„ì¹˜ ì´ë™ ì˜¤ë¥˜');
                    }
                };
                list.appendChild(item);
            });
        }

        // --- Viewer ---
        async function openBook(id) {
            showLoader('ë¡œë”© ë° ëª©ì°¨ ë¶„ì„...');
            const book = await getBook(id);
            if(!book) { hideLoader(); alert('ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); goToRoot(); return; }
            currentBookId = id; currentBookData = book;
            if (book.collectionId && !currentCollectionId) currentCollectionId = book.collectionId;
            else if (!book.collectionId) currentCollectionId = book.collectionId || null;

            document.getElementById('viewer-title').textContent = book.title;
            
            // ëª©ì°¨ ìƒì„±
            bookTOC = generateTOC(book.content);
            renderTOC();

            // í…ìŠ¤íŠ¸ ë Œë”ë§ (ëª©ì°¨ ID ì‚½ì…)
            const frag = document.createDocumentFragment();
            const lines = book.content.split(/\r?\n/);
            let tocIndex = 0;

            lines.forEach((line, lineIdx) => {
                const p = document.createElement('p');
                const trimmed = line.trim();
                
                // í˜„ì¬ ì¤„ì´ ëª©ì°¨ì— í•´ë‹¹í•˜ëŠ”ì§€ í™•ì¸
                if (tocIndex < bookTOC.length && bookTOC[tocIndex].lineIndex === lineIdx) {
                    p.id = `chapter-${tocIndex}`; // ì•µì»¤ ID ë¶€ì—¬
                    p.classList.add('chapter-title'); // ìŠ¤íƒ€ì¼ ì ìš©
                    tocIndex++;
                }
                
                p.textContent = trimmed || '\u00A0';
                frag.appendChild(p);
            });

            const cin = document.getElementById('content-inner'); cin.innerHTML=''; cin.appendChild(frag);
            
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('viewer-screen').classList.remove('hidden');
            
            applySettings();
            if(book.scrollTop) setTimeout(()=> document.getElementById('content-container').scrollTop = book.scrollTop, 50);
            else document.getElementById('content-container').scrollTop = 0;
            hideLoader();
        }

        // --- Download Logic (Merge Updated) ---
        function toggleDownloadMenu() { document.getElementById('download-menu').classList.toggle('hidden'); }

        async function downloadAsZip() {
            toggleDownloadMenu(); showLoader('ì••ì¶• ì¤‘...');
            try {
                const books = await getSortedBooks(currentCollectionId);
                if (books.length === 0) throw new Error("ì±…ì´ ì—†ìŠµë‹ˆë‹¤.");
                const zip = new JSZip();
                const folderName = currentCollectionId ? (await getCollection(currentCollectionId)).name : "WebNovel_Library";
                const usedNames = {};
                books.forEach(book => {
                    let fn = book.title.replace(/[\\/:*?"<>|]/g, "_");
                    if (usedNames[fn]) { usedNames[fn]++; fn = `${fn} (${usedNames[fn]})`; } else usedNames[fn] = 1;
                    zip.file(`${fn}.txt`, book.content);
                });
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${folderName}.zip`); hideLoader();
            } catch (e) { hideLoader(); alert(e.message); }
        }

        async function downloadAsMerged() {
            toggleDownloadMenu(); showLoader('í•©ì¹˜ëŠ” ì¤‘...');
            try {
                const books = await getSortedBooks(currentCollectionId);
                if (books.length === 0) throw new Error("ì±…ì´ ì—†ìŠµë‹ˆë‹¤.");
                const folderName = currentCollectionId ? (await getCollection(currentCollectionId)).name : "WebNovel_Merged";
                
                let mergedContent = "";
                // í•©ì¹  ë•Œ êµ¬ë¶„ìë¥¼ ëª…í™•íˆ ë„£ìŒ (ë‚˜ì¤‘ì— generateTOCê°€ ì¸ì‹í•˜ë„ë¡)
                books.forEach(book => {
                    mergedContent += `\n\n========== ${book.title} ==========\n\n`;
                    mergedContent += book.content;
                    mergedContent += "\n";
                });

                const blob = new Blob([mergedContent], { type: "text/plain;charset=utf-8" });
                saveAs(blob, `${folderName}_í•©ë³¸.txt`); hideLoader();
            } catch (e) { hideLoader(); alert(e.message); }
        }

        // --- Standard Logic (ìœ ì§€) ---
        function handleHashChange() {
            const hash = window.location.hash;
            if (hash.startsWith('#/folder/')) { const id = parseInt(hash.replace('#/folder/', '')); if (!isNaN(id)) { renderLibrary(id); document.getElementById('library-screen').classList.remove('hidden'); document.getElementById('viewer-screen').classList.add('hidden'); } } 
            else if (hash.startsWith('#/read/')) { const id = parseInt(hash.replace('#/read/', '')); if (!isNaN(id)) openBook(id); } 
            else { renderLibrary(null); document.getElementById('library-screen').classList.remove('hidden'); document.getElementById('viewer-screen').classList.add('hidden'); }
        }
        function goToRoot() { window.location.hash = '#/'; }
        function goToFolder(id) { window.location.hash = `#/folder/${id}`; }
        function goToReader(id) { window.location.hash = `#/read/${id}`; }
        function goBack() { if(currentCollectionId) goToFolder(currentCollectionId); else goToRoot(); }
        function cycleSort() {
            const btn = document.getElementById('sort-label');
            if (currentSort.field === 'lastRead' && currentSort.order === 'desc') { currentSort = { field: 'title', order: 'asc' }; btn.textContent = 'ì œëª©ìˆœ â–²'; } 
            else if (currentSort.field === 'title' && currentSort.order === 'asc') { currentSort = { field: 'title', order: 'desc' }; btn.textContent = 'ì œëª©ìˆœ â–¼'; } 
            else if (currentSort.field === 'title' && currentSort.order === 'desc') { currentSort = { field: 'lastRead', order: 'asc' }; btn.textContent = 'ì˜¤ë˜ëœìˆœ'; } 
            else { currentSort = { field: 'lastRead', order: 'desc' }; btn.textContent = 'ìµœì‹ ìˆœ'; }
            renderLibrary(currentCollectionId);
        }
        async function getSortedBooks(cid) {
            const books = await getAllBooks();
            const filtered = books.filter(b => { if(cid === null) return !b.collectionId; return b.collectionId === cid; });
            filtered.sort((a, b) => {
                let valA, valB;
                if (currentSort.field === 'title') { valA = a.title.toLowerCase(); valB = b.title.toLowerCase(); if (valA < valB) return currentSort.order === 'asc' ? -1 : 1; if (valA > valB) return currentSort.order === 'asc' ? 1 : -1; return 0; } 
                else { valA = new Date(a.lastRead).getTime(); valB = new Date(b.lastRead).getTime(); return currentSort.order === 'asc' ? valA - valB : valB - valA; }
            });
            return filtered;
        }
        async function moveToNeighbor(offset) {
            const books = await getSortedBooks(currentCollectionId);
            const idx = books.findIndex(b => b.id === currentBookId);
            if (idx === -1) return;
            const target = idx + offset;
            if (target >= 0 && target < books.length) { await updateBookProgress(books[target].id, 0, 0); goToReader(books[target].id); } 
            else alert(offset > 0 ? 'ë§ˆì§€ë§‰ì…ë‹ˆë‹¤.' : 'ì²˜ìŒì…ë‹ˆë‹¤.');
        }
        function scrollToTop() { document.getElementById('content-container').scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToBottom() { const c = document.getElementById('content-container'); c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); }
        function toggleSettings() {
            const p = document.getElementById('settings-panel'); const i = document.getElementById('settings-icon'); const c = document.getElementById('close-icon'); const b = document.getElementById('settings-toggle-btn');
            const h = p.classList.contains('panel-hidden');
            if (h) { p.classList.remove('panel-hidden'); p.classList.add('panel-visible'); i.classList.add('opacity-0', 'rotate-90'); c.classList.remove('opacity-0'); c.classList.add('rotate-90'); b.classList.add('bg-red-500', 'hover:bg-red-600'); b.classList.remove('bg-blue-600'); } 
            else { p.classList.add('panel-hidden'); p.classList.remove('panel-visible'); i.classList.remove('opacity-0', 'rotate-90'); c.classList.add('opacity-0'); c.classList.remove('rotate-90'); b.classList.remove('bg-red-500'); b.classList.add('bg-blue-600'); }
        }
        async function renderLibrary(cid = null) {
            currentCollectionId = cid; const books = await getSortedBooks(cid); const cols = await getAllCollections();
            const grid = document.getElementById('book-grid'); const empty = document.getElementById('empty-state'); const back = document.getElementById('back-to-root-btn'); const title = document.getElementById('library-title');
            grid.innerHTML = '';
            if (cid !== null) { const col = cols.find(c => c.id === cid); title.textContent = col ? col.name : 'í´ë”'; document.getElementById('library-subtitle').textContent = 'í´ë” ë‚´ë¶€'; back.classList.remove('hidden'); } 
            else { title.textContent = 'ë‚´ ì„œì¬'; document.getElementById('library-subtitle').textContent = 'ì €ì¥ëœ ì†Œì„¤ ëª©ë¡'; back.classList.add('hidden'); }
            if (cid === null) { cols.forEach(col => { const el = document.createElement('div'); el.className = 'folder-card rounded-xl shadow-sm p-4 flex flex-col items-center justify-center cursor-pointer transition-transform hover:-translate-y-1 h-40 group relative'; el.onclick = () => goToFolder(col.id); el.innerHTML = `<div class="text-5xl mb-2">ğŸ“</div><div class="font-bold text-gray-700 truncate w-full text-center px-2">${col.name}</div><div class="text-xs text-gray-400 mt-1">í´ë”</div>`; grid.appendChild(el); }); }
            books.forEach(b => {
                const p = b.progress ? Math.round(b.progress) : 0;
                const el = document.createElement('div'); el.className = 'book-card bg-white rounded-xl shadow-md overflow-hidden flex flex-col cursor-pointer group relative';
                el.innerHTML = `<div class="h-32 book-cover-${b.coverId || 1} p-4 flex items-end relative" onclick="goToReader(${b.id})"><span class="text-white font-bold text-shadow-md drop-shadow-md truncate w-full text-lg">${b.title}</span><div class="absolute top-2 right-2 bg-black/20 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm">${p}%</div></div><div class="p-3 flex justify-between items-center bg-white relative"><div class="text-xs text-gray-400 w-full" onclick="goToReader(${b.id})">ìµœê·¼: ${new Date(b.lastRead).toLocaleDateString()}</div><button onclick="toggleCardMenu(event, ${b.id})" class="p-1 rounded-full hover:bg-gray-100 text-gray-400">â‹®</button><div id="menu-${b.id}" class="hidden absolute right-2 bottom-10 w-32 bg-white rounded-lg shadow-xl border border-gray-100 z-20 flex flex-col py-1 text-sm"><button onclick="openMoveBookModal(event, ${b.id})" class="text-left px-4 py-2 hover:bg-gray-50 text-gray-700">ğŸ“‚ ì´ë™</button><button onclick="downloadBook(event, ${b.id})" class="text-left px-4 py-2 hover:bg-gray-50 text-gray-700">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button><button onclick="confirmDelete(event, ${b.id})" class="text-left px-4 py-2 hover:bg-red-50 text-red-500">ğŸ—‘ï¸ ì‚­ì œ</button></div></div>`;
                grid.appendChild(el);
            });
            if (grid.children.length === 0) { empty.classList.remove('hidden'); grid.classList.add('hidden'); } else { empty.classList.add('hidden'); grid.classList.remove('hidden'); }
        }
        function initDB(){return new Promise((r,j)=>{const q=indexedDB.open(DB_NAME,DB_VERSION);q.onerror=()=>j("Err");q.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('books')){const s=d.createObjectStore('books',{keyPath:'id',autoIncrement:true});s.createIndex('lastRead','lastRead');s.createIndex('title','title');}if(!d.objectStoreNames.contains('collections')){const s=d.createObjectStore('collections',{keyPath:'id',autoIncrement:true});s.createIndex('name','name');}};q.onsuccess=e=>{db=e.target.result;r(db)}})}
        function getAllCollections(){return new Promise(r=>{db.transaction(['collections'],'readonly').objectStore('collections').getAll().onsuccess=e=>r(e.target.result)})}
        function addCollection(n){return new Promise(r=>{db.transaction(['collections'],'readwrite').objectStore('collections').add({name:n,created:new Date()}).onsuccess=()=>r()})}
        function saveBookToDB(t,c,cid=null){return new Promise(r=>{db.transaction(['books'],'readwrite').objectStore('books').add({title:t.replace('.txt',''),content:c,progress:0,lastRead:new Date(),coverId:Math.floor(Math.random()*5)+1,collectionId:cid}).onsuccess=e=>r(e.target.result)})}
        function getAllBooks(){return new Promise(r=>{db.transaction(['books'],'readonly').objectStore('books').getAll().onsuccess=e=>r(e.target.result)})}
        function getBook(id){return new Promise(r=>{db.transaction(['books'],'readonly').objectStore('books').get(id).onsuccess=e=>r(e.target.result)})}
        function deleteBook(id){return new Promise(r=>{db.transaction(['books'],'readwrite').objectStore('books').delete(id).onsuccess=()=>r()})}
        function updateBookCollection(bid,cid){const t=db.transaction(['books'],'readwrite');const s=t.objectStore('books');s.get(bid).onsuccess=e=>{const d=e.target.result;if(d){d.collectionId=cid;s.put(d)}};return new Promise(r=>t.oncomplete=r)}
        function updateBookProgress(id,st,p){return new Promise(r=>{const t=db.transaction(['books'],'readwrite');const s=t.objectStore('books');s.get(id).onsuccess=e=>{const d=e.target.result;if(d){d.scrollTop=st;d.progress=p;d.lastRead=new Date();s.put(d)}r()}})}
        function toggleCardMenu(e,id){e.stopPropagation();document.querySelectorAll('[id^="menu-"]').forEach(el=>{if(el.id!==`menu-${id}`)el.classList.add('hidden')});const m=document.getElementById(`menu-${id}`);m.classList.toggle('hidden');const c=()=>{m.classList.add('hidden');document.removeEventListener('click',c)};setTimeout(()=>document.addEventListener('click',c),0)}
        function openCreateCollectionModal(){document.getElementById('create-collection-modal').classList.remove('hidden');document.getElementById('new-collection-name').focus()}
        function closeCreateCollectionModal(){document.getElementById('create-collection-modal').classList.add('hidden');document.getElementById('new-collection-name').value=''}
        async function createCollection(){const n=document.getElementById('new-collection-name').value.trim();if(!n)return;await addCollection(n);closeCreateCollectionModal();renderLibrary(currentCollectionId)}
        async function openMoveBookModal(e,id){e.stopPropagation();movingBookId=id;const l=document.getElementById('move-collection-list');l.innerHTML='';const cs=await getAllCollections();const rb=document.createElement('button');rb.className="w-full text-left p-3 rounded hover:bg-gray-50 border-b border-gray-100 font-medium";rb.textContent="ğŸ  ë‚´ ì„œì¬ (ë©”ì¸)";rb.onclick=()=>moveBook(null);l.appendChild(rb);cs.forEach(c=>{const b=document.createElement('button');b.className="w-full text-left p-3 rounded hover:bg-gray-50 flex items-center gap-2";b.innerHTML=`<span class="text-yellow-500">ğŸ“</span> ${c.name}`;b.onclick=()=>moveBook(c.id);l.appendChild(b)});document.getElementById('move-book-modal').classList.remove('hidden')}
        function closeMoveBookModal(){document.getElementById('move-book-modal').classList.add('hidden');movingBookId=null}
        async function moveBook(cid){if(movingBookId){await updateBookCollection(movingBookId,cid);closeMoveBookModal();renderLibrary(currentCollectionId)}}
        function openUploadModal(){document.getElementById('upload-modal').classList.remove('hidden');document.getElementById('file-input').value='';document.getElementById('selected-filename').classList.add('hidden')}
        function closeUploadModal(){document.getElementById('upload-modal').classList.add('hidden')}
        function openWriteModal(){document.getElementById('write-title').value='';document.getElementById('write-content').value='';document.getElementById('write-modal').classList.remove('hidden')}
        function closeWriteModal(){document.getElementById('write-modal').classList.add('hidden')}
        async function processUpload(){const f=document.getElementById('file-input').files[0];if(!f){alert('íŒŒì¼ ì„ íƒ');return}closeUploadModal();showLoader('ì €ì¥ ì¤‘...');const enc=document.getElementById('encoding-select').value;const r=new FileReader();r.onload=async(e)=>{try{await saveBookToDB(f.name,e.target.result,currentCollectionId);renderLibrary(currentCollectionId);hideLoader()}catch(err){alert('ì‹¤íŒ¨:'+err);hideLoader()}};r.readAsText(f,enc)}
        async function saveWrittenNovel(){const t=document.getElementById('write-title').value.trim();const c=document.getElementById('write-content').value;if(!t||!c)return alert('ë‚´ìš© ì…ë ¥');closeWriteModal();showLoader('ì €ì¥ ì¤‘...');try{await saveBookToDB(t,c,currentCollectionId);renderLibrary(currentCollectionId);hideLoader()}catch(e){alert('ì‹¤íŒ¨:'+e);hideLoader()}}
        async function confirmDelete(e,id){e.stopPropagation();if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){await deleteBook(id);renderLibrary(currentCollectionId)}}
        async function downloadBook(e,id){e.stopPropagation();const b=await getBook(id);if(!b)return;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([b.content],{type:'text/plain'}));a.download=`${b.title}.txt`;document.body.appendChild(a);a.click();document.body.removeChild(a)}
        
        // P2P/Sync UI
        function openSyncModal(){document.getElementById('sync-modal').classList.remove('hidden');resetSyncView()}
        function closeSyncModal(){document.getElementById('sync-modal').classList.add('hidden');cleanupPeer();stopScanner()}
        function resetSyncView(){document.getElementById('sync-main-view').classList.remove('hidden');document.getElementById('sync-host-view').classList.add('hidden');document.getElementById('sync-client-view').classList.add('hidden');updateSyncStatus('',false);document.getElementById('host-code-display').textContent='-----';document.getElementById('qrcode-container').innerHTML='';document.getElementById('target-peer-id').value='';cleanupPeer();stopScanner()}
        function cleanupPeer(){if(conn){conn.close();conn=null}if(peer){peer.destroy();peer=null}}
        function updateSyncStatus(m,s){const el=document.getElementById('sync-status');document.getElementById('sync-status-text').textContent=m;if(s)el.classList.remove('hidden');else el.classList.add('hidden')}
        function generateShortId(){return Math.floor(10000+Math.random()*90000).toString()}
        function startHostMode(){document.getElementById('sync-main-view').classList.add('hidden');document.getElementById('sync-host-view').classList.remove('hidden');updateSyncStatus('ì½”ë“œ ìƒì„± ì¤‘...',true);peer=new Peer(generateShortId());peer.on('open',(id)=>{document.getElementById('host-code-display').textContent=id;updateSyncStatus('ëŒ€ê¸° ì¤‘...',true);document.getElementById('qrcode-container').innerHTML='';new QRCode(document.getElementById('qrcode-container'),{text:id,width:160,height:160})});peer.on('connection',(c)=>{conn=c;updateSyncStatus('ì—°ê²°ë¨! ì „ì†¡ ì¤€ë¹„...',true);conn.on('open',async()=>{updateSyncStatus('ì „ì†¡ ì¤‘...',true);const d=await getExportData();conn.send(d);updateSyncStatus('ì „ì†¡ ì™„ë£Œ!',true)})});peer.on('error',()=>{cleanupPeer();startHostMode()})}
        function startClientMode(){document.getElementById('sync-main-view').classList.add('hidden');document.getElementById('sync-client-view').classList.remove('hidden');updateSyncStatus('',false);peer=new Peer();peer.on('error',e=>alert('ì˜¤ë¥˜:'+e.type))}
        function startScanner(){document.getElementById('manual-input-container').classList.add('hidden');document.getElementById('qr-reader-container').classList.remove('hidden');html5QrCode=new Html5Qrcode("reader");html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},(t)=>{stopScanner();document.getElementById('target-peer-id').value=t;connectToPeer()})}
        function stopScanner(){if(html5QrCode)html5QrCode.stop().then(()=>{html5QrCode.clear();html5QrCode=null}).catch(()=>{});document.getElementById('qr-reader-container').classList.add('hidden');document.getElementById('manual-input-container').classList.remove('hidden')}
        function connectToPeer(){const id=document.getElementById('target-peer-id').value.trim();if(!id)return alert('ì½”ë“œ ì…ë ¥');updateSyncStatus('ì—°ê²° ì‹œë„...',true);conn=peer.connect(id);conn.on('open',()=>updateSyncStatus('ì—°ê²° ì„±ê³µ! ìˆ˜ì‹  ëŒ€ê¸°...',true));conn.on('data',async(d)=>{updateSyncStatus('ìˆ˜ì‹  ì¤‘...',true);try{const r=await importData(d);updateSyncStatus('ì™„ë£Œ!',true);alert(`ì™„ë£Œ! ì¶”ê°€:${r.added}, ì¤‘ë³µ:${r.skipped}`);closeSyncModal();renderLibrary(currentCollectionId)}catch(e){alert('ì‹¤íŒ¨:'+e)}});setTimeout(()=>{if(!conn||!conn.open)updateSyncStatus('ì‹œê°„ ì´ˆê³¼',true)},8000)}
        async function exportAllData(){try{showLoader('ìƒì„± ì¤‘...');const d=await getExportData();const b=new Blob([JSON.stringify(d)],{type:"application/json"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`library_backup.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);hideLoader();closeSyncModal()}catch(e){hideLoader();alert('ì‹¤íŒ¨:'+e)}}
        async function importFromFile(i){const f=i.files[0];if(!f)return;if(!confirm('ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¤‘ë³µì€ ê±´ë„ˆëœë‹ˆë‹¤.')){i.value='';return}showLoader('ë¶„ì„ ì¤‘...');const r=new FileReader();r.onload=async(e)=>{try{const d=JSON.parse(e.target.result);const res=await importData(d);hideLoader();alert(`ì™„ë£Œ! ì¶”ê°€:${res.added}, ì¤‘ë³µ:${res.skipped}`);closeSyncModal();renderLibrary(currentCollectionId)}catch(err){hideLoader();alert('ì‹¤íŒ¨:'+err)}};r.readAsText(f)}
        async function getExportData(){const b=await getAllBooks();const c=await getAllCollections();return{version:2,books:b,collections:c,settings:settings}}
        async function importData(d){if(!d.books)throw new Error("Invalid");const mc=await getAllCollections();const mb=await getAllBooks();const cm={};const tx=db.transaction(['books','collections'],'readwrite');const cs=tx.objectStore('collections');const bs=tx.objectStore('books');if(d.collections){for(const c of d.collections){const ex=mc.find(m=>m.name===c.name);if(ex)cm[c.id]=ex.id;else{const{id,...r}=c;const ni=await new Promise(z=>{cs.add(r).onsuccess=e=>z(e.target.result)});cm[c.id]=ni;mc.push({...r,id:ni})}}}let ac=0,sc=0;for(const b of d.books){const ex=mb.find(m=>m.title===b.title);if(ex){sc++;continue}const{id,collectionId,...r}=b;if(collectionId&&cm[collectionId])r.collectionId=cm[collectionId];else r.collectionId=null;bs.add(r);ac++}if(d.settings){settings=d.settings;saveSettings()}return{added:ac,skipped:sc}}
        function showLoader(m){document.getElementById('loader-text').textContent=m;document.getElementById('loader-overlay').classList.remove('hidden')}
        function hideLoader(){document.getElementById('loader-overlay').classList.add('hidden')}
        function throttle(f,l){let t;return function(){if(!t){f.apply(this,arguments);t=true;setTimeout(()=>t=false,l)}}}
        function setTheme(t){const v=document.getElementById('viewer-screen');v.className=v.className.replace(/theme-\w+/,'').trim()+' '+t;settings.theme=t;saveSettings()}
        function setFont(t){settings.fontFamily=t;const ci=document.getElementById('content-inner');if(t==='sans'){ci.classList.remove('font-serif-kr');ci.classList.add('font-sans-kr')}else{ci.classList.remove('font-sans-kr');ci.classList.add('font-serif-kr')}saveSettings()}
        function adjustSize(d){settings.fontSize=Math.max(12,Math.min(40,settings.fontSize+d));applyStyleUpdates();saveSettings()}
        function adjustLineHeight(d){settings.lineHeight=Math.round((Math.max(1.2,Math.min(3.0,settings.lineHeight+d)))*10)/10;applyStyleUpdates();saveSettings()}
        function applyStyleUpdates(){const ci=document.getElementById('content-inner');ci.style.fontSize=`${settings.fontSize}px`;ci.style.lineHeight=settings.lineHeight}
        function applySettings(){setTheme(settings.theme);setFont(settings.fontFamily);applyStyleUpdates()}
        function saveSettings(){localStorage.setItem('webNovelReaderSettings',JSON.stringify(settings))}
        function loadSettings(){const s=localStorage.getItem('webNovelReaderSettings');if(s)settings={...settings,...JSON.parse(s)}}
        function updateProgress(){const c=document.getElementById('content-container');const p=(c.scrollTop/(c.scrollHeight-c.clientHeight))*100||0;document.getElementById('progress-bar').style.width=`${p}%`;return{scrollTop:c.scrollTop,percent:p}}
        function saveScrollPosition(){if(currentBookId){const{scrollTop,percent}=updateProgress();updateBookProgress(currentBookId,scrollTop,percent)}}
        async function shareNovel(){if(!currentBookData)return;const d={title:currentBookData.title,text:currentBookData.content.substring(0,5000)};if(navigator.share)try{await navigator.share(d)}catch(e){}else try{await navigator.clipboard.writeText(currentBookData.content);alert('ë³µì‚¬ë¨')}catch(e){}}

        init();
    </script>
</body>
</html>


