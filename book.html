<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›¹ì†Œì„¤ ë¦¬ë” - ë‚´ ì„œì¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }

        .font-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-serif-kr { font-family: 'Noto Serif KR', serif; }

        /* --- í…Œë§ˆ ì •ì˜ --- */
        .theme-white { --bg-color: #ffffff; --text-color: #111827; }
        .theme-sepia { --bg-color: #f6f1e3; --text-color: #5f4b32; } 
        .theme-dark { --bg-color: #374151; --text-color: #e5e7eb; }
        .theme-mint { --bg-color: #e0f2f1; --text-color: #004d40; }
        .theme-black { --bg-color: #000000; --text-color: #9ca3af; }

        /* --- ë·°ì–´ í™”ë©´ ìŠ¤íƒ€ì¼ --- */
        #viewer-screen {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            transition: background-color 0.3s, color 0.3s;
        }

        .viewer-content p {
            color: inherit !important; 
            margin-bottom: 1.2em;
            min-height: 1em;
            word-break: keep-all;
            text-align: justify;
        }
        
        .viewer-header-gradient {
            background: linear-gradient(to bottom, var(--bg-color), transparent);
        }

        /* ì±… ì»¤ë²„ ìŠ¤íƒ€ì¼ */
        .book-cover-1 { background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); }
        .book-cover-2 { background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); }
        .book-cover-3 { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .book-cover-4 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .book-cover-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .book-card { transition: transform 0.2s, box-shadow 0.2s; }
        .book-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        
        /* í´ë” ìŠ¤íƒ€ì¼ */
        .folder-card { background: #fefce8; border: 1px solid #fde047; }
        .folder-card:hover { background: #fef9c3; }

        #settings-panel { transition: transform 0.3s ease-in-out; }
        .panel-hidden { transform: translateY(100%); }
        .panel-visible { transform: translateY(0); }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #reader { width: 100%; border-radius: 0.5rem; overflow: hidden; }
        .code-input { letter-spacing: 0.5em; text-align: center; font-size: 1.5rem; font-family: monospace; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans-kr overflow-hidden text-gray-800 touch-pan-y">

    <!-- 1. ì„œì¬ í™”ë©´ (Library) -->
    <div id="library-screen" class="flex-1 flex flex-col h-full bg-gray-50 text-gray-800 overflow-hidden">
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center shadow-sm z-10 gap-4">
            <div class="flex items-center justify-between w-full md:w-auto gap-4">
                <div class="flex items-center gap-2">
                    <button id="back-to-root-btn" onclick="navigateToRoot()" class="hidden mr-2 p-2 rounded-full hover:bg-gray-100 text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div>
                        <h1 id="library-title" class="text-2xl font-bold text-gray-800">ë‚´ ì„œì¬</h1>
                        <p id="library-subtitle" class="text-xs text-gray-500 mt-1">ì €ì¥ëœ ì†Œì„¤ ëª©ë¡</p>
                    </div>
                    <!-- ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ -->
                    <button onclick="openSyncModal()" class="text-gray-400 hover:text-blue-600 transition-colors p-2 rounded-full hover:bg-gray-100" title="ê¸°ê¸° ê°„ ë™ê¸°í™” (P2P)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </button>
                    <!-- í´ë” ì¶”ê°€ ë²„íŠ¼ -->
                    <button onclick="openCreateCollectionModal()" class="text-gray-400 hover:text-yellow-500 transition-colors p-2 rounded-full hover:bg-gray-100" title="ìƒˆ í´ë” ë§Œë“¤ê¸°">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="openWriteModal()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    <span>ê¸€ì“°ê¸°</span>
                </button>
                <button onclick="openUploadModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>íŒŒì¼ ì—…ë¡œë“œ</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6" id="library-container">
            <div id="book-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-7xl mx-auto">
                <!-- í´ë”ì™€ ì±… ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
            
            <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 space-y-4 pb-20">
                <div class="text-6xl">ğŸ“‚</div>
                <p class="text-lg">í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                <p class="text-sm">ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œì„¤ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
            </div>
        </main>
    </div>

    <!-- 2. ë·°ì–´ í™”ë©´ (Viewer) -->
    <div id="viewer-screen" class="hidden fixed inset-0 z-50 flex flex-col theme-sepia">
        <div class="absolute top-0 left-0 w-full h-1 bg-current/10 z-50">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-150" style="width: 0%"></div>
        </div>

        <header class="viewer-header-gradient absolute top-0 w-full p-4 flex justify-between items-center z-40 h-20 transition-opacity duration-300 opacity-0 hover:opacity-100">
            <button onclick="handleBack()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>ë’¤ë¡œê°€ê¸°</span>
            </button>
            <h2 id="viewer-title" class="text-lg font-bold truncate max-w-[40%] text-center px-4 drop-shadow-md">ì œëª©</h2>
            <button onclick="shareNovel()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm" title="ê³µìœ í•˜ê¸°">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
            </button>
        </header>

        <main id="content-container" class="h-full overflow-y-auto px-4 pb-32 pt-16 md:px-0 scroll-smooth">
            <div id="content-inner" class="viewer-content max-w-3xl mx-auto text-lg leading-relaxed outline-none min-h-screen" tabindex="0">
                <!-- í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜ì—­ -->
            </div>
            <div class="h-20"></div>
        </main>

        <div class="absolute bottom-6 right-6 z-40">
            <button onclick="toggleSettings()" class="w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center text-xl hover:bg-blue-700 transition-transform active:scale-95 hover:rotate-90 duration-300">
                âš™ï¸
            </button>
        </div>

        <div id="settings-panel" class="absolute bottom-0 left-0 w-full bg-[var(--bg-color)] border-t border-current/10 p-6 z-50 panel-hidden shadow-2xl rounded-t-2xl">
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="w-12 h-1 bg-current/20 rounded-full mx-auto mb-2 cursor-pointer" onclick="toggleSettings()"></div>
                <div class="space-y-2">
                    <label class="text-sm font-bold opacity-70">ë°°ê²½ í…Œë§ˆ</label>
                    <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setTheme('theme-white')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-white flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-sepia')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#f6f1e3] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-mint')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#e0f2f1] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-dark')" class="w-10 h-10 rounded-full border border-gray-600 shadow-sm bg-[#374151] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-black')" class="w-10 h-10 rounded-full border border-gray-700 shadow-sm bg-[#000000] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">ê¸€ê¼´</label>
                        <div class="flex bg-current/5 rounded-lg p-1">
                            <button onclick="setFont('sans')" id="btn-font-sans" class="flex-1 py-2 rounded-md text-sm font-sans-kr transition-colors">ê³ ë”•</button>
                            <button onclick="setFont('serif')" id="btn-font-serif" class="flex-1 py-2 rounded-md text-sm font-serif-kr transition-colors">ëª…ì¡°</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">í¬ê¸° ë° ê°„ê²©</label>
                        <div class="flex items-center space-x-3">
                            <button onclick="adjustSize(-1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">-</button>
                            <span id="font-size-display" class="font-mono text-sm w-8 text-center"></span>
                            <button onclick="adjustSize(1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">+</button>
                            <div class="h-4 w-px bg-current/20 mx-1"></div>
                            <button onclick="adjustLineHeight(-0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ì¢ê²Œ</button>
                            <button onclick="adjustLineHeight(0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ë„“ê²Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- P2P ë™ê¸°í™” ëª¨ë‹¬ -->
    <div id="sync-modal" class="fixed inset-0 bg-black/50 z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeSyncModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">âœ•</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                ê¸°ê¸° ê°„ ë™ê¸°í™”
            </h3>
            <p class="text-sm text-gray-600 mb-6">
                QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ <span class="font-bold text-blue-600">5ìë¦¬ ì½”ë“œ</span>ë¥¼ ì…ë ¥í•˜ì—¬<br>ê¸°ê¸°ë¼ë¦¬ ì§ì ‘ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.
            </p>
            <div id="sync-main-view" class="space-y-4">
                <button onclick="startHostMode()" class="w-full bg-blue-50 hover:bg-blue-100 border border-blue-200 text-blue-700 p-4 rounded-xl flex items-center justify-between group transition-colors">
                    <div class="text-left">
                        <div class="font-bold">ğŸ“¤ ë°ì´í„° ë³´ë‚´ê¸° (Host)</div>
                        <div class="text-xs opacity-70">ì¼íšŒìš© ì½”ë“œ ìƒì„± ë° ì „ì†¡ ëŒ€ê¸°</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
                <button onclick="startClientMode()" class="w-full bg-green-50 hover:bg-green-100 border border-green-200 text-green-700 p-4 rounded-xl flex items-center justify-between group transition-colors">
                    <div class="text-left">
                        <div class="font-bold">ğŸ“¥ ë°ì´í„° ë°›ê¸° (Client)</div>
                        <div class="text-xs opacity-70">ì½”ë“œ ì…ë ¥ ë˜ëŠ” QR ìŠ¤ìº”</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>
            <div id="sync-host-view" class="hidden flex flex-col items-center text-center space-y-4">
                <p class="text-sm text-gray-600">ë°›ëŠ” ê¸°ê¸°ì— ì•„ë˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                <div class="bg-gray-50 border-2 border-dashed border-blue-300 rounded-xl p-4 w-full">
                     <p class="text-xs text-gray-500 mb-1">ì¼íšŒìš© ì—°ê²° ì½”ë“œ</p>
                     <div id="host-code-display" class="text-4xl font-mono font-bold tracking-widest text-blue-600 select-all">-----</div>
                </div>
                <div class="relative w-full flex items-center py-2">
                     <div class="flex-grow border-t border-gray-200"></div><span class="flex-shrink-0 mx-2 text-gray-400 text-xs">ë˜ëŠ” QR ìŠ¤ìº”</span><div class="flex-grow border-t border-gray-200"></div>
                </div>
                <div id="qrcode-container" class="bg-white p-2 rounded-lg border shadow-sm"></div>
                <button onclick="resetSyncView()" class="text-gray-500 text-sm hover:underline mt-2">ë’¤ë¡œ ê°€ê¸°</button>
            </div>
            <div id="sync-client-view" class="hidden flex flex-col space-y-4">
                <div id="manual-input-container" class="space-y-4">
                    <div class="text-center">
                        <label class="text-sm text-gray-600 block mb-2">ë³´ë‚´ëŠ” ê¸°ê¸°ì˜ 5ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
                        <input type="number" id="target-peer-id" placeholder="12345" class="code-input w-full border-2 border-gray-300 rounded-xl p-3 outline-none focus:border-blue-500 focus:bg-blue-50 transition-colors" maxlength="5">
                    </div>
                    <button onclick="connectToPeer()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">ì—°ê²°í•˜ê¸°</button>
                    <div class="relative w-full flex items-center py-2"><div class="flex-grow border-t border-gray-200"></div><span class="flex-shrink-0 mx-2 text-gray-400 text-xs">ë˜ëŠ” QR ìŠ¤ìº”</span><div class="flex-grow border-t border-gray-200"></div></div>
                   <button onclick="startScanner()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>ì¹´ë©”ë¼ ì¼œê¸°
                    </button>
                </div>
                <div id="qr-reader-container" class="hidden">
                    <div id="reader" class="bg-black"></div>
                    <button onclick="stopScanner()" class="w-full mt-2 py-2 bg-gray-200 rounded text-sm font-medium">ì¹´ë©”ë¼ ë„ê¸°</button>
                </div>
                <button onclick="resetSyncView()" class="text-gray-500 text-sm hover:underline text-center mt-2">ë’¤ë¡œ ê°€ê¸°</button>
            </div>
            <div id="sync-status" class="mt-4 text-center hidden">
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-bold animate-pulse">
                    <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                    <span id="sync-status-text">ìƒíƒœ ë©”ì‹œì§€</span>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="upload-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">ìƒˆ ì†Œì„¤ ì¶”ê°€</h3>
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer relative">
                <input type="file" id="file-input" accept=".txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="text-4xl mb-2">ğŸ“‚</div>
                <p class="text-gray-600 font-medium">TXT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                <p id="selected-filename" class="text-blue-600 text-sm mt-2 hidden"></p>
            </div>
            <div class="mt-4 flex items-center gap-2 text-sm text-gray-600 justify-center">
                <label>ì¸ì½”ë”©:</label>
                <select id="encoding-select" class="border rounded px-2 py-1">
                    <option value="utf-8">UTF-8 (ê¸°ë³¸)</option>
                    <option value="euc-kr">EUC-KR (ê¹¨ì§ ë°©ì§€)</option>
                </select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeUploadModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="processUpload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="write-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col p-6 shadow-2xl relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ì†Œì„¤ ì“°ê¸°</h3>
                <button onclick="closeWriteModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                <input type="text" id="write-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full text-lg font-bold p-3 border-b-2 border-gray-200 focus:border-green-500 outline-none">
                <textarea id="write-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full flex-1 p-3 resize-none focus:bg-gray-50 outline-none text-base leading-relaxed overflow-y-auto"></textarea>
            </div>
            <div class="mt-4 flex justify-end gap-3">
                <button onclick="closeWriteModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="saveWrittenNovel()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm font-bold">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì»¬ë ‰ì…˜ ìƒì„± ëª¨ë‹¬ -->
    <div id="create-collection-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
            <h3 class="text-lg font-bold mb-4">ìƒˆ í´ë” ë§Œë“¤ê¸°</h3>
            <input type="text" id="new-collection-name" placeholder="í´ë” ì´ë¦„ (ì˜ˆ: ë¬´í˜‘, ë¡œë§¨ìŠ¤)" class="w-full border-2 border-gray-200 rounded-xl p-3 outline-none focus:border-yellow-400 mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeCreateCollectionModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="createCollection()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">ë§Œë“¤ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì†Œì„¤ ì´ë™ ëª¨ë‹¬ -->
    <div id="move-book-modal" class="fixed inset-0 bg-black/50 z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative flex flex-col max-h-[80vh]">
            <h3 class="text-lg font-bold mb-4">ì´ë™í•  í´ë” ì„ íƒ</h3>
            <div id="move-collection-list" class="flex-1 overflow-y-auto space-y-2">
                <!-- í´ë” ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeMoveBookModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loader-overlay" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center space-y-4">
            <div class="loader"></div>
            <p id="loader-text" class="text-gray-800 font-medium">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <script>
        const DB_NAME = 'WebNovelLibrary';
        const DB_VERSION = 3; // ë²„ì „ ì¦ê°€ (ì¤‘ë³µ ë°©ì§€ìš© ì¸ë±ìŠ¤ ì¶”ê°€)
        let db;
        let currentBookId = null;
        let currentBookData = null;
        let currentCollectionId = null;
        let movingBookId = null;

        let settings = {
            theme: 'theme-sepia',
            fontSize: 20,
            lineHeight: 1.8,
            fontFamily: 'sans'
        };

        let peer = null;
        let conn = null;
        let html5QrCode = null;

        async function init() {
            loadSettings();
            await initDB();
            await renderLibrary();
            
            document.getElementById('file-input').addEventListener('change', function() {
                if(this.files[0]) {
                    document.getElementById('selected-filename').textContent = this.files[0].name;
                    document.getElementById('selected-filename').classList.remove('hidden');
                }
            });

            document.getElementById('content-container').addEventListener('scroll', throttle(() => {
                updateProgress();
                if(currentBookId) saveScrollPosition();
            }, 1000));
            
            window.addEventListener('popstate', (event) => {
                if (!event.state || event.state.view !== 'reader') {
                    closeViewerUI();
                }
            });
        }

        // --- P2P Logic ---
        function openSyncModal() { document.getElementById('sync-modal').classList.remove('hidden'); resetSyncView(); }
        function closeSyncModal() { document.getElementById('sync-modal').classList.add('hidden'); cleanupPeer(); stopScanner(); }
        function resetSyncView() {
            document.getElementById('sync-main-view').classList.remove('hidden');
            document.getElementById('sync-host-view').classList.add('hidden');
            document.getElementById('sync-client-view').classList.add('hidden');
            updateSyncStatus('', false);
            document.getElementById('host-code-display').textContent = '-----';
            document.getElementById('qrcode-container').innerHTML = '';
            document.getElementById('target-peer-id').value = '';
            cleanupPeer(); stopScanner();
        }
        function cleanupPeer() { if (conn) { conn.close(); conn = null; } if (peer) { peer.destroy(); peer = null; } }
        function updateSyncStatus(msg, show) { const el = document.getElementById('sync-status'); document.getElementById('sync-status-text').textContent = msg; if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function generateShortId() { return Math.floor(10000 + Math.random() * 90000).toString(); }

        function startHostMode() {
            document.getElementById('sync-main-view').classList.add('hidden');
            document.getElementById('sync-host-view').classList.remove('hidden');
            updateSyncStatus('ì½”ë“œ ìƒì„± ì¤‘...', true);
            peer = new Peer(generateShortId());
            peer.on('open', (id) => {
                document.getElementById('host-code-display').textContent = id;
                updateSyncStatus('ì—°ê²° ëŒ€ê¸° ì¤‘...', true);
                document.getElementById('qrcode-container').innerHTML = '';
                new QRCode(document.getElementById('qrcode-container'), { text: id, width: 160, height: 160 });
            });
            peer.on('connection', (c) => {
                conn = c;
                updateSyncStatus('ì—°ê²°ë¨! ì „ì†¡ ì¤€ë¹„...', true);
                conn.on('open', async () => {
                    updateSyncStatus('ë°ì´í„° ì „ì†¡ ì¤‘...', true);
                    const exportData = await getExportData();
                    conn.send(exportData);
                    updateSyncStatus('ì „ì†¡ ì™„ë£Œ!', true);
                });
            });
            peer.on('error', () => { cleanupPeer(); startHostMode(); });
        }

        function startClientMode() {
            document.getElementById('sync-main-view').classList.add('hidden');
            document.getElementById('sync-client-view').classList.remove('hidden');
            updateSyncStatus('', false);
            peer = new Peer();
            peer.on('error', err => alert('ì˜¤ë¥˜: ' + err.type));
        }
        function startScanner() {
            document.getElementById('manual-input-container').classList.add('hidden');
            document.getElementById('qr-reader-container').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (txt) => { stopScanner(); document.getElementById('target-peer-id').value = txt; connectToPeer(); });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; }).catch(()=>{}); document.getElementById('qr-reader-container').classList.add('hidden'); document.getElementById('manual-input-container').classList.remove('hidden'); }
        function connectToPeer() {
            const targetId = document.getElementById('target-peer-id').value.trim();
            if (!targetId) return alert('ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            updateSyncStatus('ì—°ê²° ì‹œë„ ì¤‘...', true);
            conn = peer.connect(targetId);
            conn.on('open', () => updateSyncStatus('ì—°ê²° ì„±ê³µ! ìˆ˜ì‹  ëŒ€ê¸°...', true));
            conn.on('data', async (data) => {
                updateSyncStatus('ë°ì´í„° ìˆ˜ì‹  ì¤‘...', true);
                try { await importData(data); updateSyncStatus('ë™ê¸°í™” ì™„ë£Œ!', true); alert('ë™ê¸°í™” ì™„ë£Œ!'); closeSyncModal(); renderLibrary(); } catch(e) { alert('ì‹¤íŒ¨: ' + e); }
            });
            setTimeout(() => { if(!conn || !conn.open) updateSyncStatus('ì—°ê²° ì‹œê°„ ì´ˆê³¼', true); }, 8000);
        }

        async function getExportData() {
            const books = await getAllBooks();
            const collections = await getAllCollections();
            return { version: 2, books, collections, settings };
        }

        // --- Import Logic (ì¤‘ë³µ ì²´í¬ ì¶”ê°€ë¨) ---
        async function importData(data) {
            if (!data.books) throw new Error("Invalid Data");

            // 1. ê¸°ì¡´ ì»¬ë ‰ì…˜ ë° ì±… ì •ë³´ ë©”ëª¨ë¦¬ì— ë¡œë“œ (ì¤‘ë³µ ì²´í¬ìš©)
            const myCollections = await getAllCollections();
            const myBooks = await getAllBooks();
            
            // ì»¬ë ‰ì…˜ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ (ì´ë¦„ ê°™ìœ¼ë©´ ê¸°ì¡´êº¼ ì‚¬ìš©)
            const collectionMap = {}; // oldId -> newId
            const tx = db.transaction(['books', 'collections'], 'readwrite');
            const cStore = tx.objectStore('collections');
            const bStore = tx.objectStore('books');

            // 2. ì»¬ë ‰ì…˜ ì²˜ë¦¬
            if (data.collections) {
                for (const c of data.collections) {
                    const existing = myCollections.find(mc => mc.name === c.name);
                    if (existing) {
                        collectionMap[c.id] = existing.id;
                    } else {
                        // ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                        const { id, ...rest } = c;
                        const newId = await new Promise(res => {
                            const req = cStore.add(rest);
                            req.onsuccess = e => res(e.target.result);
                        });
                        collectionMap[c.id] = newId;
                        // ë©”ëª¨ë¦¬ì—ë„ ì¶”ê°€í•´ë‘¬ì•¼ ê°™ì€ ì´ë¦„ ì¤‘ë³µ ìƒì„± ë°©ì§€ë¨ (ì´ë²ˆ ë°°ì¹˜ ë‚´ì—ì„œ)
                        myCollections.push({ ...rest, id: newId });
                    }
                }
            }

            // 3. ì±… ì²˜ë¦¬ (ì œëª© ì¤‘ë³µ ì²´í¬)
            let addedCount = 0;
            let skippedCount = 0;
            
            for (const b of data.books) {
                // ì œëª©ìœ¼ë¡œ ì¤‘ë³µ í™•ì¸
                const existing = myBooks.find(mb => mb.title === b.title);
                if (existing) {
                    skippedCount++;
                    continue; // ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë„ˆëœ€
                }

                // ì»¬ë ‰ì…˜ ID ë§¤í•‘
                const { id, collectionId, ...rest } = b;
                if (collectionId && collectionMap[collectionId]) {
                    rest.collectionId = collectionMap[collectionId];
                } else {
                    rest.collectionId = null; // ë§¤í•‘ ì‹¤íŒ¨ ì‹œ ë£¨íŠ¸ë¡œ
                }
                
                bStore.add(rest);
                addedCount++;
            }

            if (data.settings) { settings = data.settings; saveSettings(); }
            
            return { added: addedCount, skipped: skippedCount };
        }

        // --- DB Functions (v3 Upgrade) ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("DB Error");
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    // ì±… ìŠ¤í† ì–´
                    if (!db.objectStoreNames.contains('books')) {
                        const store = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('lastRead', 'lastRead', { unique: false });
                        store.createIndex('title', 'title', { unique: false }); // v3: title ì¸ë±ìŠ¤ ì¶”ê°€
                    } else {
                        // ê¸°ì¡´ ìŠ¤í† ì–´ì— ì¸ë±ìŠ¤ ì¶”ê°€
                        const store = e.target.transaction.objectStore('books');
                        if(!store.indexNames.contains('title')) {
                            store.createIndex('title', 'title', { unique: false });
                        }
                    }
                    
                    // ì»¬ë ‰ì…˜ ìŠ¤í† ì–´
                    if (!db.objectStoreNames.contains('collections')) {
                        const store = db.createObjectStore('collections', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false }); // v3: name ì¸ë±ìŠ¤ ì¶”ê°€
                    } else {
                        const store = e.target.transaction.objectStore('collections');
                        if(!store.indexNames.contains('name')) {
                            store.createIndex('name', 'name', { unique: false });
                        }
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            });
        }

        // DB Helpers
        function getAllCollections() {
            return new Promise((resolve) => {
                const tx = db.transaction(['collections'], 'readonly');
                tx.objectStore('collections').getAll().onsuccess = (e) => resolve(e.target.result);
            });
        }
        function getCollection(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(['collections'], 'readonly');
                tx.objectStore('collections').get(id).onsuccess = (e) => resolve(e.target.result);
            });
        }
        function addCollection(name) {
            return new Promise((resolve) => {
                const tx = db.transaction(['collections'], 'readwrite');
                tx.objectStore('collections').add({ name, created: new Date() }).onsuccess = () => resolve();
            });
        }
        function saveBookToDB(title, content, collectionId = null) {
            return new Promise((resolve) => {
                const tx = db.transaction(['books'], 'readwrite');
                const book = { title: title.replace('.txt', ''), content, progress: 0, lastRead: new Date(), coverId: Math.floor(Math.random() * 5) + 1, collectionId };
                tx.objectStore('books').add(book).onsuccess = (e) => resolve(e.target.result);
            });
        }
        function getAllBooks() {
            return new Promise((resolve) => {
                const tx = db.transaction(['books'], 'readonly');
                tx.objectStore('books').getAll().onsuccess = (e) => resolve(e.target.result);
            });
        }
        function getBook(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(['books'], 'readonly');
                tx.objectStore('books').get(id).onsuccess = (e) => resolve(e.target.result);
            });
        }
        function deleteBook(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(['books'], 'readwrite');
                tx.objectStore('books').delete(id).onsuccess = () => resolve();
            });
        }
        function updateBookCollection(bookId, collectionId) {
            const tx = db.transaction(['books'], 'readwrite');
            const store = tx.objectStore('books');
            store.get(bookId).onsuccess = (e) => {
                const data = e.target.result;
                if(data) {
                    data.collectionId = collectionId;
                    store.put(data);
                }
            };
            return new Promise(r => tx.oncomplete = r);
        }
        function updateBookProgress(id, scrollTop, percent) {
            const tx = db.transaction(['books'], 'readwrite');
            const store = tx.objectStore('books');
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                if (data) {
                    data.scrollTop = scrollTop;
                    data.progress = percent;
                    data.lastRead = new Date();
                    store.put(data);
                }
            };
        }

        // --- Library UI ---
        async function renderLibrary(collectionId = null) {
            currentCollectionId = collectionId;
            const books = await getAllBooks();
            const collections = await getAllCollections();
            
            // í•„í„°ë§
            const filteredBooks = books.filter(b => {
                if(collectionId === null) return !b.collectionId; // ë£¨íŠ¸ë©´ ì»¬ë ‰ì…˜ ì—†ëŠ”ê±°
                return b.collectionId === collectionId;
            });
            filteredBooks.sort((a, b) => b.lastRead - a.lastRead);

            const grid = document.getElementById('book-grid');
            const emptyState = document.getElementById('empty-state');
            const backBtn = document.getElementById('back-to-root-btn');
            const titleEl = document.getElementById('library-title');
            
            grid.innerHTML = '';
            
            // í—¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸
            if (collectionId !== null) {
                const col = collections.find(c => c.id === collectionId);
                titleEl.textContent = col ? col.name : 'í´ë”';
                document.getElementById('library-subtitle').textContent = 'í´ë” ë‚´ë¶€';
                backBtn.classList.remove('hidden');
            } else {
                titleEl.textContent = 'ë‚´ ì„œì¬';
                document.getElementById('library-subtitle').textContent = 'ì €ì¥ëœ ì†Œì„¤ ëª©ë¡';
                backBtn.classList.add('hidden');
            }

            // ë£¨íŠ¸ì¼ ë•Œë§Œ í´ë” ë Œë”ë§
            if (collectionId === null) {
                collections.forEach(col => {
                    const el = document.createElement('div');
                    el.className = 'folder-card rounded-xl shadow-sm p-4 flex flex-col items-center justify-center cursor-pointer transition-transform hover:-translate-y-1 h-40 group relative';
                    el.onclick = () => renderLibrary(col.id);
                    el.innerHTML = `
                        <div class="text-5xl mb-2">ğŸ“</div>
                        <div class="font-bold text-gray-700 truncate w-full text-center px-2">${col.name}</div>
                        <div class="text-xs text-gray-400 mt-1">í´ë”</div>
                    `;
                    grid.appendChild(el);
                });
            }

            // ì±… ë Œë”ë§
            filteredBooks.forEach(book => {
                const progress = book.progress ? Math.round(book.progress) : 0;
                const el = document.createElement('div');
                el.className = 'book-card bg-white rounded-xl shadow-md overflow-hidden flex flex-col cursor-pointer group relative';
                el.innerHTML = `
                    <div class="h-32 book-cover-${book.coverId || 1} p-4 flex items-end relative" onclick="openBook(${book.id})">
                        <span class="text-white font-bold text-shadow-md drop-shadow-md truncate w-full text-lg">${book.title}</span>
                        <div class="absolute top-2 right-2 bg-black/20 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm">${progress}%</div>
                    </div>
                    <div class="p-3 flex justify-between items-center bg-white relative">
                        <div class="text-xs text-gray-400 w-full" onclick="openBook(${book.id})">ìµœê·¼: ${new Date(book.lastRead).toLocaleDateString()}</div>
                        
                        <!-- ë©”ë‰´ ë²„íŠ¼ -->
                        <button onclick="toggleCardMenu(event, ${book.id})" class="p-1 rounded-full hover:bg-gray-100 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                            </svg>
                        </button>

                        <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
                        <div id="menu-${book.id}" class="hidden absolute right-2 bottom-10 w-32 bg-white rounded-lg shadow-xl border border-gray-100 z-20 flex flex-col py-1 text-sm">
                            <button onclick="openMoveBookModal(event, ${book.id})" class="text-left px-4 py-2 hover:bg-gray-50 text-gray-700">ğŸ“‚ ì´ë™</button>
                            <button onclick="downloadBook(event, ${book.id})" class="text-left px-4 py-2 hover:bg-gray-50 text-gray-700">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="confirmDelete(event, ${book.id})" class="text-left px-4 py-2 hover:bg-red-50 text-red-500">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });

            if (grid.children.length === 0) {
                emptyState.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                grid.classList.remove('hidden');
            }
        }

        function navigateToRoot() {
            renderLibrary(null);
        }

        // --- Card Menu ---
        function toggleCardMenu(e, id) {
            e.stopPropagation();
            // ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ ë‹«ê¸°
            document.querySelectorAll('[id^="menu-"]').forEach(el => {
                if (el.id !== `menu-${id}`) el.classList.add('hidden');
            });
            const menu = document.getElementById(`menu-${id}`);
            menu.classList.toggle('hidden');
            
            // í™”ë©´ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡
            const closeMenu = () => {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        // --- ì»¬ë ‰ì…˜ ê´€ë¦¬ ---
        function openCreateCollectionModal() { document.getElementById('create-collection-modal').classList.remove('hidden'); document.getElementById('new-collection-name').focus(); }
        function closeCreateCollectionModal() { document.getElementById('create-collection-modal').classList.add('hidden'); document.getElementById('new-collection-name').value = ''; }
        
        async function createCollection() {
            const name = document.getElementById('new-collection-name').value.trim();
            if(!name) return;
            await addCollection(name);
            closeCreateCollectionModal();
            renderLibrary(currentCollectionId);
        }

        async function openMoveBookModal(e, bookId) {
            e.stopPropagation(); // ë©”ë‰´ ë‹«í˜ ë°©ì§€ (ì´ë¯¸ ì´ë²¤íŠ¸ ë²„ë¸”ë§ìœ¼ë¡œ ë‹«í ìˆ˜ ìˆìœ¼ë‚˜ ì•ˆì „ì¥ì¹˜)
            movingBookId = bookId;
            const listEl = document.getElementById('move-collection-list');
            listEl.innerHTML = '';
            
            const collections = await getAllCollections();
            
            // ë£¨íŠ¸ë¡œ ì´ë™ ì˜µì…˜
            const rootBtn = document.createElement('button');
            rootBtn.className = "w-full text-left p-3 rounded hover:bg-gray-50 border-b border-gray-100 font-medium";
            rootBtn.textContent = "ğŸ  ë‚´ ì„œì¬ (ë©”ì¸)";
            rootBtn.onclick = () => moveBook(null);
            listEl.appendChild(rootBtn);

            collections.forEach(col => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded hover:bg-gray-50 flex items-center gap-2";
                btn.innerHTML = `<span class="text-yellow-500">ğŸ“</span> ${col.name}`;
                btn.onclick = () => moveBook(col.id);
                listEl.appendChild(btn);
            });

            document.getElementById('move-book-modal').classList.remove('hidden');
        }

        function closeMoveBookModal() { document.getElementById('move-book-modal').classList.add('hidden'); movingBookId = null; }

        async function moveBook(targetCollectionId) {
            if(movingBookId) {
                await updateBookCollection(movingBookId, targetCollectionId);
                closeMoveBookModal();
                renderLibrary(currentCollectionId);
            }
        }

        // --- ê¸°ë³¸ ê¸°ëŠ¥ ---
        function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('file-input').value = ''; document.getElementById('selected-filename').classList.add('hidden'); }
        function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
        function openWriteModal() { document.getElementById('write-title').value = ''; document.getElementById('write-content').value = ''; document.getElementById('write-modal').classList.remove('hidden'); }
        function closeWriteModal() { document.getElementById('write-modal').classList.add('hidden'); }
        
        async function processUpload() {
            const file = document.getElementById('file-input').files[0];
            if (!file) { alert('íŒŒì¼ ì„ íƒ í•„ìš”'); return; }
            closeUploadModal();
            showLoader('ì €ì¥ ì¤‘...');
            const enc = document.getElementById('encoding-select').value;
            const r = new FileReader();
            r.onload = async (e) => {
                try { await saveBookToDB(file.name, e.target.result, currentCollectionId); await renderLibrary(currentCollectionId); hideLoader(); } 
                catch(err) { alert('ì‹¤íŒ¨: ' + err); hideLoader(); }
            };
            r.readAsText(file, enc);
        }

        async function saveWrittenNovel() {
            const t = document.getElementById('write-title').value.trim();
            const c = document.getElementById('write-content').value;
            if(!t || !c) return alert('ë‚´ìš© ì…ë ¥ í•„ìš”');
            closeWriteModal(); showLoader('ì €ì¥ ì¤‘...');
            try { await saveBookToDB(t, c, currentCollectionId); await renderLibrary(currentCollectionId); hideLoader(); }
            catch(err) { alert('ì‹¤íŒ¨: ' + err); hideLoader(); }
        }

        async function confirmDelete(e, id) { e.stopPropagation(); if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await deleteBook(id); await renderLibrary(currentCollectionId); } }
        async function downloadBook(e, id) {
            e.stopPropagation();
            const book = await getBook(id); if(!book) return;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([book.content],{type:'text/plain'})); a.download = `${book.title}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- ë·°ì–´ ---
        async function openBook(id) {
            showLoader('ë¡œë”© ì¤‘...');
            const book = await getBook(id);
            if(!book) { hideLoader(); return alert('ì˜¤ë¥˜'); }
            currentBookId = id; currentBookData = book;
            document.getElementById('viewer-title').textContent = book.title;
            const frag = document.createDocumentFragment();
            book.content.split(/\r?\n/).forEach(l => { const p=document.createElement('p'); p.textContent=l.trim()||'\u00A0'; frag.appendChild(p); });
            const cin = document.getElementById('content-inner'); cin.innerHTML=''; cin.appendChild(frag);
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('viewer-screen').classList.remove('hidden');
            history.pushState({view:'reader', bookId:id},'','#reader');
            applySettings();
            if(book.scrollTop) setTimeout(()=>document.getElementById('content-container').scrollTop=book.scrollTop, 100);
            hideLoader();
        }

        function handleBack() { if(history.state?.view==='reader') history.back(); else closeViewerUI(); }
        function closeViewerUI() { saveScrollPosition(); renderLibrary(currentCollectionId); document.getElementById('viewer-screen').classList.add('hidden'); document.getElementById('library-screen').classList.remove('hidden'); currentBookId=null; }

        function showLoader(m) { document.getElementById('loader-text').textContent=m; document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }
        function throttle(f,l) { let t; return function(){ if(!t){ f.apply(this,arguments); t=true; setTimeout(()=>t=false,l); }}}
        
        function toggleSettings() { const p=document.getElementById('settings-panel'); p.classList.toggle('panel-hidden'); p.classList.toggle('panel-visible'); }
        function setTheme(t) { const v=document.getElementById('viewer-screen'); v.className = v.className.replace(/theme-\w+/,'').trim()+' '+t; settings.theme=t; saveSettings(); }
        function setFont(t) { settings.fontFamily=t; const ci=document.getElementById('content-inner'); if(t==='sans'){ci.classList.remove('font-serif-kr');ci.classList.add('font-sans-kr');}else{ci.classList.remove('font-sans-kr');ci.classList.add('font-serif-kr');} saveSettings(); }
        function adjustSize(d) { settings.fontSize=Math.max(12,Math.min(40,settings.fontSize+d)); applyStyleUpdates(); saveSettings(); }
        function adjustLineHeight(d) { settings.lineHeight=Math.round((Math.max(1.2,Math.min(3.0,settings.lineHeight+d)))*10)/10; applyStyleUpdates(); saveSettings(); }
        function applyStyleUpdates() { const ci=document.getElementById('content-inner'); ci.style.fontSize=`${settings.fontSize}px`; ci.style.lineHeight=settings.lineHeight; }
        function applySettings() { setTheme(settings.theme); setFont(settings.fontFamily); applyStyleUpdates(); }
        function saveSettings() { localStorage.setItem('webNovelReaderSettings', JSON.stringify(settings)); }
        function loadSettings() { const s=localStorage.getItem('webNovelReaderSettings'); if(s) settings={...settings,...JSON.parse(s)}; }

        function updateProgress() {
            const c=document.getElementById('content-container');
            const p=(c.scrollTop/(c.scrollHeight-c.clientHeight))*100 || 0;
            document.getElementById('progress-bar').style.width=`${p}%`;
            return {scrollTop:c.scrollTop, percent:p};
        }
        function saveScrollPosition() { if(currentBookId) { const {scrollTop, percent}=updateProgress(); updateBookProgress(currentBookId, scrollTop, percent); }}
        
        async function shareNovel() {
            if(!currentBookData) return;
            const d = { title: currentBookData.title, text: currentBookData.content.substring(0,5000) };
            if(navigator.share) try{await navigator.share(d)}catch(e){} else try{await navigator.clipboard.writeText(currentBookData.content); alert('ë³µì‚¬ë¨');}catch(e){}
        }

        init();
    </script>
</body>
</html>


