<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›¹ì†Œì„¤ ë¦¬ë” - ë‚´ ì„œì¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }

        .font-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-serif-kr { font-family: 'Noto Serif KR', serif; }

        /* --- í…Œë§ˆ ì •ì˜ (CSS ë³€ìˆ˜) --- */
        .theme-white { --bg-color: #ffffff; --text-color: #111827; }
        .theme-sepia { --bg-color: #f6f1e3; --text-color: #5f4b32; } 
        .theme-dark { --bg-color: #374151; --text-color: #e5e7eb; }
        .theme-mint { --bg-color: #e0f2f1; --text-color: #004d40; }
        .theme-black { --bg-color: #000000; --text-color: #9ca3af; }

        /* --- ë·°ì–´ í™”ë©´ ìŠ¤íƒ€ì¼ --- */
        #viewer-screen {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            transition: background-color 0.3s, color 0.3s;
        }

        .viewer-content p {
            color: inherit !important; 
            margin-bottom: 1.2em;
            min-height: 1em;
            word-break: keep-all;
            text-align: justify;
        }
        
        .viewer-header-gradient {
            background: linear-gradient(to bottom, var(--bg-color), transparent);
        }

        /* ì±… ì»¤ë²„ ìŠ¤íƒ€ì¼ */
        .book-cover-1 { background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); }
        .book-cover-2 { background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); }
        .book-cover-3 { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .book-cover-4 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .book-cover-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .book-card { transition: transform 0.2s, box-shadow 0.2s; }
        .book-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        #settings-panel { transition: transform 0.3s ease-in-out; }
        .panel-hidden { transform: translateY(100%); }
        .panel-visible { transform: translateY(0); }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans-kr overflow-hidden text-gray-800 touch-pan-y">

    <!-- 1. ì„œì¬ í™”ë©´ (Library) -->
    <div id="library-screen" class="flex-1 flex flex-col h-full bg-gray-50 text-gray-800 overflow-hidden">
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center shadow-sm z-10 gap-4">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">ë‚´ ì„œì¬</h1>
                    <p class="text-xs text-gray-500 mt-1">ì €ì¥ëœ ì†Œì„¤ ëª©ë¡</p>
                </div>
                <button onclick="openInfoModal()" class="text-gray-400 hover:text-blue-500 transition-colors p-1" title="ì €ì¥ì†Œ ì•ˆë‚´">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="openWriteModal()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    <span>ê¸€ì“°ê¸°</span>
                </button>
                <button onclick="openUploadModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>íŒŒì¼ ì—…ë¡œë“œ</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6" id="library-container">
            <div id="book-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-7xl mx-auto">
                <!-- ì±… ì¹´ë“œë“¤ -->
            </div>
            
            <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 space-y-4 pb-20">
                <div class="text-6xl">ğŸ“š</div>
                <p class="text-lg">ì„œì¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                <p class="text-sm">ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œì„¤ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
            </div>
        </main>
    </div>

    <!-- 2. ë·°ì–´ í™”ë©´ (Viewer) -->
    <div id="viewer-screen" class="hidden fixed inset-0 z-50 flex flex-col theme-sepia">
        <!-- ìƒë‹¨ ì§„í–‰ë¥  ë°” -->
        <div class="absolute top-0 left-0 w-full h-1 bg-current/10 z-50">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-150" style="width: 0%"></div>
        </div>

        <!-- ë·°ì–´ í—¤ë” -->
        <header class="viewer-header-gradient absolute top-0 w-full p-4 flex justify-between items-center z-40 h-20 transition-opacity duration-300 opacity-0 hover:opacity-100">
            <button onclick="closeViewer()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm">
                <span>â† ë‚˜ê°€ê¸°</span>
            </button>
            <h2 id="viewer-title" class="text-lg font-bold truncate max-w-[40%] text-center px-4 drop-shadow-md">ì œëª©</h2>
            <button onclick="shareNovel()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-black/10 transition-colors text-sm font-medium opacity-70 hover:opacity-100 bg-white/20 backdrop-blur-sm" title="ê³µìœ í•˜ê¸°">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
            </button>
        </header>

        <!-- í…ìŠ¤íŠ¸ ì»¨í…ì¸  -->
        <main id="content-container" class="h-full overflow-y-auto px-4 pb-32 pt-16 md:px-0 scroll-smooth">
            <div id="content-inner" class="viewer-content max-w-3xl mx-auto text-lg leading-relaxed outline-none min-h-screen" tabindex="0">
                <!-- í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜ì—­ -->
            </div>
            <div class="h-20"></div>
        </main>

        <!-- ì„¤ì • ë²„íŠ¼ -->
        <div class="absolute bottom-6 right-6 z-40">
            <button onclick="toggleSettings()" class="w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center text-xl hover:bg-blue-700 transition-transform active:scale-95 hover:rotate-90 duration-300">
                âš™ï¸
            </button>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ -->
        <div id="settings-panel" class="absolute bottom-0 left-0 w-full bg-[var(--bg-color)] border-t border-current/10 p-6 z-50 panel-hidden shadow-2xl rounded-t-2xl">
            <div class="max-w-3xl mx-auto space-y-6">
                <!-- í•¸ë“¤ëŸ¬ -->
                <div class="w-12 h-1 bg-current/20 rounded-full mx-auto mb-2 cursor-pointer" onclick="toggleSettings()"></div>

                <!-- í…Œë§ˆ -->
                <div class="space-y-2">
                    <label class="text-sm font-bold opacity-70">ë°°ê²½ í…Œë§ˆ</label>
                    <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setTheme('theme-white')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-white flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-sepia')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#f6f1e3] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-mint')" class="w-10 h-10 rounded-full border border-gray-300 shadow-sm bg-[#e0f2f1] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-dark')" class="w-10 h-10 rounded-full border border-gray-600 shadow-sm bg-[#374151] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                        <button onclick="setTheme('theme-black')" class="w-10 h-10 rounded-full border border-gray-700 shadow-sm bg-[#000000] flex-shrink-0 ring-offset-2 focus:ring-2 ring-blue-500"></button>
                    </div>
                </div>

                <!-- í°íŠ¸/í¬ê¸° -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">ê¸€ê¼´</label>
                        <div class="flex bg-current/5 rounded-lg p-1">
                            <button onclick="setFont('sans')" id="btn-font-sans" class="flex-1 py-2 rounded-md text-sm font-sans-kr transition-colors">ê³ ë”•</button>
                            <button onclick="setFont('serif')" id="btn-font-serif" class="flex-1 py-2 rounded-md text-sm font-serif-kr transition-colors">ëª…ì¡°</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">í¬ê¸° ë° ê°„ê²©</label>
                        <div class="flex items-center space-x-3">
                            <button onclick="adjustSize(-1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">-</button>
                            <span id="font-size-display" class="font-mono text-sm w-8 text-center"></span>
                            <button onclick="adjustSize(1)" class="w-8 h-8 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center">+</button>
                            <div class="h-4 w-px bg-current/20 mx-1"></div>
                            <button onclick="adjustLineHeight(-0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ì¢ê²Œ</button>
                            <button onclick="adjustLineHeight(0.1)" class="px-2 py-1 rounded bg-current/10 hover:bg-current/20 text-xs">ë„“ê²Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="upload-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">ìƒˆ ì†Œì„¤ ì¶”ê°€</h3>
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer relative">
                <input type="file" id="file-input" accept=".txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="text-4xl mb-2">ğŸ“‚</div>
                <p class="text-gray-600 font-medium">TXT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                <p id="selected-filename" class="text-blue-600 text-sm mt-2 hidden"></p>
            </div>
            <div class="mt-4 flex items-center gap-2 text-sm text-gray-600 justify-center">
                <label>ì¸ì½”ë”©:</label>
                <select id="encoding-select" class="border rounded px-2 py-1">
                    <option value="utf-8">UTF-8 (ê¸°ë³¸)</option>
                    <option value="euc-kr">EUC-KR (ê¹¨ì§ ë°©ì§€)</option>
                </select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeUploadModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="processUpload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="write-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col p-6 shadow-2xl relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ì†Œì„¤ ì“°ê¸°</h3>
                <button onclick="closeWriteModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            
            <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                <input type="text" id="write-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full text-lg font-bold p-3 border-b-2 border-gray-200 focus:border-green-500 outline-none">
                <textarea id="write-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full flex-1 p-3 resize-none focus:bg-gray-50 outline-none text-base leading-relaxed overflow-y-auto"></textarea>
            </div>

            <div class="mt-4 flex justify-end gap-3">
                <button onclick="closeWriteModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="saveWrittenNovel()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm font-bold">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì•ˆë‚´ ëª¨ë‹¬ -->
    <div id="info-modal" class="fixed inset-0 bg-black/50 z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ì•ˆë‚´ ë° ê¸°ëŠ¥
            </h3>
            <div class="space-y-3 text-sm text-gray-600 leading-relaxed">
                <p><span class="font-bold text-gray-800">Q. PCì—ì„œ íŒŒì¼ì„ ì§€ì›Œë„ ë˜ë‚˜ìš”?</span><br>A. ë„¤! ì„œì¬ì— ì €ì¥ëœ ì±…ì€ ë¸Œë¼ìš°ì € ë‚´ë¶€ì— ë³´ê´€ë©ë‹ˆë‹¤.</p>
                <p><span class="font-bold text-gray-800">Q. ê³µìœ ëŠ” ì–´ë–»ê²Œ í•˜ë‚˜ìš”?</span><br>A. ì†Œì„¤ì„ ì—´ê³  ìš°ì¸¡ ìƒë‹¨ ê³µìœ  ì•„ì´ì½˜ì„ ëˆ„ë¥´ë©´ í…ìŠ¤íŠ¸ë¥¼ ê³µìœ í•˜ê±°ë‚˜ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p class="bg-blue-50 p-3 rounded-lg text-blue-700">
                    ğŸ’¡ ì„œì¬ì— ìˆëŠ” ì±…ì€ <span class="font-bold">ë‹¤ìš´ë¡œë“œ</span>í•˜ì—¬ PCì— ë°±ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeInfoModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-medium">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loader-overlay" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center space-y-4">
            <div class="loader"></div>
            <p id="loader-text" class="text-gray-800 font-medium">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <script>
        const DB_NAME = 'WebNovelLibrary';
        const DB_VERSION = 1;
        let db;
        let currentBookId = null;
        let currentBookData = null; // ê³µìœ ë¥¼ ìœ„í•´ í˜„ì¬ ì±… ë°ì´í„° ì €ì¥
        let settings = {
            theme: 'theme-sepia',
            fontSize: 20,
            lineHeight: 1.8,
            fontFamily: 'sans'
        };

        async function init() {
            loadSettings();
            await initDB();
            await renderLibrary();
            
            // íŒŒì¼ ì…ë ¥ ê°ì§€
            document.getElementById('file-input').addEventListener('change', function() {
                if(this.files[0]) {
                    document.getElementById('selected-filename').textContent = this.files[0].name;
                    document.getElementById('selected-filename').classList.remove('hidden');
                }
            });

            // ìŠ¤í¬ë¡¤ ì €ì¥
            document.getElementById('content-container').addEventListener('scroll', throttle(() => {
                updateProgress();
                if(currentBookId) saveScrollPosition();
            }, 1000));
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("DB Error");
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('books')) {
                        const store = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('lastRead', 'lastRead', { unique: false });
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            });
        }

        function saveBookToDB(title, content) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['books'], 'readwrite');
                const store = tx.objectStore('books');
                const book = { title: title.replace('.txt', ''), content, progress: 0, lastRead: new Date(), coverId: Math.floor(Math.random() * 5) + 1 };
                const req = store.add(book);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function getAllBooks() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['books'], 'readonly');
                const req = tx.objectStore('books').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function getBook(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['books'], 'readonly');
                const req = tx.objectStore('books').get(id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function deleteBook(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(['books'], 'readwrite');
                tx.objectStore('books').delete(id).onsuccess = () => resolve();
            });
        }

        function updateBookProgress(id, scrollTop, percent) {
            const tx = db.transaction(['books'], 'readwrite');
            const store = tx.objectStore('books');
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                if (data) {
                    data.scrollTop = scrollTop;
                    data.progress = percent;
                    data.lastRead = new Date();
                    store.put(data);
                }
            };
        }

        async function renderLibrary() {
            const books = await getAllBooks();
            books.sort((a, b) => b.lastRead - a.lastRead);
            const grid = document.getElementById('book-grid');
            const emptyState = document.getElementById('empty-state');
            grid.innerHTML = '';
            
            if (books.length === 0) {
                emptyState.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                grid.classList.remove('hidden');
                books.forEach(book => {
                    const progress = book.progress ? Math.round(book.progress) : 0;
                    const date = new Date(book.lastRead).toLocaleDateString();
                    const el = document.createElement('div');
                    el.className = 'book-card bg-white rounded-xl shadow-md overflow-hidden flex flex-col cursor-pointer group relative';
                    el.innerHTML = `
                        <div class="h-32 book-cover-${book.coverId || 1} p-4 flex items-end relative" onclick="openBook(${book.id})">
                            <span class="text-white font-bold text-shadow-md drop-shadow-md truncate w-full text-lg">${book.title}</span>
                            <div class="absolute top-2 right-2 bg-black/20 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm">${progress}%</div>
                        </div>
                        <div class="p-3 flex justify-between items-center bg-white">
                            <div class="text-xs text-gray-400" onclick="openBook(${book.id})">ìµœê·¼: ${date}</div>
                            <div class="flex gap-1">
                                <button onclick="downloadBook(event, ${book.id})" class="text-gray-400 hover:text-blue-500 p-1 rounded-full hover:bg-gray-100" title="ë‹¤ìš´ë¡œë“œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>
                                <button onclick="confirmDelete(event, ${book.id})" class="text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-gray-100" title="ì‚­ì œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            }
        }

        async function downloadBook(e, id) {
            e.stopPropagation();
            const book = await getBook(id);
            if (!book) return;
            const element = document.createElement('a');
            const file = new Blob([book.content], {type: 'text/plain'});
            element.href = URL.createObjectURL(file);
            element.download = `${book.title}.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // --- ëª¨ë‹¬ ê´€ë¦¬ ---
        function openUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
            document.getElementById('file-input').value = '';
            document.getElementById('selected-filename').classList.add('hidden');
        }
        function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
        
        function openWriteModal() {
            document.getElementById('write-title').value = '';
            document.getElementById('write-content').value = '';
            document.getElementById('write-modal').classList.remove('hidden');
        }
        function closeWriteModal() { document.getElementById('write-modal').classList.add('hidden'); }
        
        function openInfoModal() { document.getElementById('info-modal').classList.remove('hidden'); }
        function closeInfoModal() { document.getElementById('info-modal').classList.add('hidden'); }

        // --- ì—…ë¡œë“œ ë° ì €ì¥ ---
        async function processUpload() {
            const file = document.getElementById('file-input').files[0];
            if (!file) { alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            closeUploadModal();
            showLoader('ì„œì¬ì— ë„£ëŠ” ì¤‘...');
            const encoding = document.getElementById('encoding-select').value;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await saveBookToDB(file.name, e.target.result);
                    await renderLibrary();
                    hideLoader();
                } catch (err) {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + err);
                    hideLoader();
                }
            };
            reader.readAsText(file, encoding);
        }

        async function saveWrittenNovel() {
            const title = document.getElementById('write-title').value.trim();
            const content = document.getElementById('write-content').value;
            
            if (!title) { alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!content) { alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            closeWriteModal();
            showLoader('ì €ì¥ ì¤‘...');
            try {
                await saveBookToDB(title, content);
                await renderLibrary();
                hideLoader();
            } catch (err) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + err);
                hideLoader();
            }
        }

        async function confirmDelete(e, id) {
            e.stopPropagation();
            if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await deleteBook(id); await renderLibrary(); }
        }

        // --- ë·°ì–´ ê¸°ëŠ¥ ---
        async function openBook(id) {
            showLoader('ì±… í´ëŠ” ì¤‘...');
            const book = await getBook(id);
            if (!book) { alert('ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); hideLoader(); return; }
            
            currentBookId = id;
            currentBookData = book; // ê³µìœ ìš© ë°ì´í„°
            document.getElementById('viewer-title').textContent = book.title;
            
            const fragment = document.createDocumentFragment();
            const lines = book.content.split(/\r?\n/);
            lines.forEach(line => {
                const trimmed = line.trim();
                const p = document.createElement('p');
                if (trimmed.length > 0) p.textContent = trimmed;
                else p.innerHTML = '&nbsp;';
                fragment.appendChild(p);
            });
            
            const contentInner = document.getElementById('content-inner');
            contentInner.innerHTML = '';
            contentInner.appendChild(fragment);
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('viewer-screen').classList.remove('hidden');
            applySettings();
            if (book.scrollTop) {
                setTimeout(() => { document.getElementById('content-container').scrollTop = book.scrollTop; }, 100);
            }
            hideLoader();
        }

        // --- ê³µìœ  ê¸°ëŠ¥ ---
        async function shareNovel() {
            if (!currentBookData) return;

            const shareData = {
                title: currentBookData.title,
                text: currentBookData.content.substring(0, 5000) + (currentBookData.content.length > 5000 ? "\n...(ìƒëµë¨)" : ""),
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Share failed:', err);
                }
            } else {
                try {
                    await navigator.clipboard.writeText(currentBookData.content);
                    alert('ì†Œì„¤ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (err) {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        function closeViewer() {
            saveScrollPosition();
            renderLibrary();
            document.getElementById('viewer-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.remove('hidden');
            currentBookId = null;
            currentBookData = null;
        }

        function showLoader(msg) {
            document.getElementById('loader-text').textContent = msg;
            document.getElementById('loader-overlay').classList.remove('hidden');
        }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

        function updateProgress() {
            const container = document.getElementById('content-container');
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight - container.clientHeight;
            const percent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            return { scrollTop, percent };
        }

        function saveScrollPosition() {
            if (!currentBookId) return;
            const { scrollTop, percent } = updateProgress();
            updateBookProgress(currentBookId, scrollTop, percent);
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('panel-hidden');
            panel.classList.toggle('panel-visible');
        }

        function setTheme(themeName) {
            const viewer = document.getElementById('viewer-screen');
            viewer.className = viewer.className.replace(/theme-\w+/, '').trim() + ' ' + themeName;
            
            const classes = viewer.classList;
            ['theme-white', 'theme-sepia', 'theme-dark', 'theme-mint', 'theme-black'].forEach(t => classes.remove(t));
            classes.add(themeName);

            settings.theme = themeName;
            saveSettings();
        }

        function setFont(type) {
            settings.fontFamily = type;
            const sansBtn = document.getElementById('btn-font-sans');
            const serifBtn = document.getElementById('btn-font-serif');
            const contentInner = document.getElementById('content-inner');
            if (type === 'sans') {
                contentInner.classList.remove('font-serif-kr');
                contentInner.classList.add('font-sans-kr');
                sansBtn.classList.add('bg-white/90', 'text-black', 'shadow-sm'); sansBtn.classList.remove('opacity-60');
                serifBtn.classList.remove('bg-white/90', 'text-black', 'shadow-sm'); serifBtn.classList.add('opacity-60');
            } else {
                contentInner.classList.remove('font-sans-kr');
                contentInner.classList.add('font-serif-kr');
                serifBtn.classList.add('bg-white/90', 'text-black', 'shadow-sm'); serifBtn.classList.remove('opacity-60');
                sansBtn.classList.remove('bg-white/90', 'text-black', 'shadow-sm'); sansBtn.classList.add('opacity-60');
            }
            saveSettings();
        }

        function adjustSize(delta) {
            settings.fontSize = Math.max(12, Math.min(40, settings.fontSize + delta));
            applyStyleUpdates();
            saveSettings();
        }
        function adjustLineHeight(delta) {
            settings.lineHeight = Math.round((Math.max(1.2, Math.min(3.0, settings.lineHeight + delta))) * 10) / 10;
            applyStyleUpdates();
            saveSettings();
        }
        function applyStyleUpdates() {
            const contentInner = document.getElementById('content-inner');
            contentInner.style.fontSize = `${settings.fontSize}px`;
            contentInner.style.lineHeight = settings.lineHeight;
            document.getElementById('font-size-display').textContent = `${settings.fontSize}`;
        }
        function applySettings() {
            setTheme(settings.theme);
            setFont(settings.fontFamily);
            applyStyleUpdates();
        }
        function saveSettings() { localStorage.setItem('webNovelReaderSettings', JSON.stringify(settings)); }
        function loadSettings() {
            const saved = localStorage.getItem('webNovelReaderSettings');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
        }

        init();
    </script>
</body>
</html>


