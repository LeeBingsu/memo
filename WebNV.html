<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ì†Œì„¤ ë¦¬ë” (Web Novel Reader)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.8);
        }

        /* í°íŠ¸ í´ë˜ìŠ¤ */
        .font-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-serif-kr { font-family: 'Noto Serif KR', serif; }

        /* í…Œë§ˆë³„ ìŠ¤íƒ€ì¼ ì •ì˜ */
        .theme-white { --bg-color: #ffffff; --text-color: #111827; --sub-text: #6b7280; --accent: #3b82f6; }
        .theme-sepia { --bg-color: #f6f1e3; --text-color: #4b3621; --sub-text: #8c7b6d; --accent: #8b5cf6; }
        .theme-dark { --bg-color: #1f2937; --text-color: #d1d5db; --sub-text: #9ca3af; --accent: #60a5fa; }
        .theme-mint { --bg-color: #e0f2f1; --text-color: #004d40; --sub-text: #4db6ac; --accent: #00897b; }
        .theme-black { --bg-color: #000000; --text-color: #9ca3af; --sub-text: #4b5563; --accent: #3b82f6; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .viewer-content p {
            margin-bottom: 1.2em; /* ë¬¸ë‹¨ ê°„ê²© */
            min-height: 1em; /* ë¹ˆ ì¤„ë„ ë†’ì´ ìœ ì§€ */
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
            text-align: justify; /* ì–‘ìª½ ì •ë ¬ */
        }
        
        /* ì„¤ì • íŒ¨ë„ ì• ë‹ˆë©”ì´ì…˜ */
        #settings-panel {
            transition: transform 0.3s ease-in-out;
        }
        .panel-hidden {
            transform: translateY(100%);
        }
        .panel-visible {
            transform: translateY(0);
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="theme-sepia h-screen flex flex-col overflow-hidden font-sans-kr selection:bg-blue-200 selection:text-blue-900">

    <!-- ìƒë‹¨ ì§„í–‰ë¥  ë°” -->
    <div class="fixed top-0 left-0 w-full h-1 bg-gray-200/20 z-50">
        <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-150" style="width: 0%"></div>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ í™”ë©´ (ì´ˆê¸° í™”ë©´) -->
    <div id="upload-screen" class="flex-1 flex flex-col items-center justify-center p-6 space-y-8 animate-fade-in">
        <div class="text-center space-y-2">
            <h1 class="text-4xl font-bold mb-2">ì›¹ì†Œì„¤ ë¦¬ë”</h1>
            <p class="opacity-70">TXT íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í¸ì•ˆí•˜ê²Œ ê°ìƒí•˜ì„¸ìš”</p>
        </div>

        <div class="w-full max-w-md bg-white/10 backdrop-blur-md border border-current/10 rounded-2xl p-8 text-center shadow-lg hover:shadow-xl transition-all border-dashed border-2 border-gray-400/50">
            <input type="file" id="file-input" accept=".txt" class="hidden">
            <label for="file-input" class="cursor-pointer block space-y-4">
                <div class="mx-auto w-16 h-16 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl">
                    ğŸ“‚
                </div>
                <div>
                    <span class="text-lg font-medium hover:underline">íŒŒì¼ ì„ íƒí•˜ê¸°</span>
                    <p class="text-sm opacity-60 mt-1">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                </div>
            </label>
        </div>

        <!-- ì¸ì½”ë”© ì„¤ì • (í•œê¸€ ê¹¨ì§ ë°©ì§€) -->
        <div class="flex items-center space-x-2 text-sm opacity-80">
            <label for="encoding-select">ì¸ì½”ë”©:</label>
            <select id="encoding-select" class="bg-transparent border border-current/30 rounded px-2 py-1 outline-none">
                <option value="utf-8" class="text-black">UTF-8 (ê¸°ë³¸)</option>
                <option value="euc-kr" class="text-black">EUC-KR (í•œê¸€ ê¹¨ì§ˆ ë•Œ)</option>
            </select>
        </div>
    </div>

    <!-- ë·°ì–´ í™”ë©´ (ìˆ¨ê¹€ ìƒíƒœ) -->
    <div id="viewer-screen" class="hidden flex-1 relative h-full">
        <!-- ìƒë‹¨ í—¤ë” (ì œëª© ë° ë‹«ê¸°) -->
        <header class="absolute top-0 w-full p-4 flex justify-between items-center z-40 bg-gradient-to-b from-[var(--bg-color)] to-transparent h-20 transition-opacity duration-300 opacity-0 hover:opacity-100 group">
            <h2 id="file-title" class="text-lg font-bold truncate max-w-[70%] pl-2">ì œëª© ì—†ìŒ</h2>
            <button onclick="resetApp()" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="íŒŒì¼ ë‹«ê¸°">
                âœ•
            </button>
        </header>

        <!-- í…ìŠ¤íŠ¸ ì»¨í…ì¸  ì˜ì—­ -->
        <main id="content-container" class="h-full overflow-y-auto px-4 pb-32 pt-12 md:px-0 scroll-smooth">
            <div id="content-inner" class="viewer-content max-w-3xl mx-auto text-lg leading-relaxed outline-none min-h-screen" tabindex="0">
                <!-- í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë Œë”ë§ ë©ë‹ˆë‹¤ -->
            </div>
            <div id="scroll-sentinel" class="h-10"></div>
        </main>

        <!-- í•˜ë‹¨ í”Œë¡œíŒ… ë©”ë‰´ ë²„íŠ¼ -->
        <div class="absolute bottom-6 right-6 z-40">
            <button id="settings-toggle" class="w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center text-2xl hover:bg-blue-700 transition-transform active:scale-95 hover:rotate-90 duration-300">
                âš™ï¸
            </button>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ (ìŠ¬ë¼ì´ë“œ ì—…) -->
        <div id="settings-panel" class="absolute bottom-0 left-0 w-full bg-[var(--bg-color)] border-t border-current/10 p-6 z-50 panel-hidden shadow-[0_-10px_40px_rgba(0,0,0,0.1)] rounded-t-2xl">
            <div class="max-w-3xl mx-auto space-y-6">
                <!-- í•¸ë“¤ëŸ¬ (ë“œë˜ê·¸ ëŠë‚Œ) -->
                <div class="w-12 h-1 bg-current/20 rounded-full mx-auto mb-2 cursor-pointer" onclick="toggleSettings()"></div>

                <!-- í…Œë§ˆ ì„ íƒ -->
                <div class="space-y-2">
                    <label class="text-sm font-bold opacity-70">ë°°ê²½ í…Œë§ˆ</label>
                    <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setTheme('theme-white')" class="w-12 h-12 rounded-full border border-gray-300 shadow-sm bg-white flex-shrink-0 focus:ring-2 ring-blue-500" title="í™”ì´íŠ¸"></button>
                        <button onclick="setTheme('theme-sepia')" class="w-12 h-12 rounded-full border border-gray-300 shadow-sm bg-[#f6f1e3] flex-shrink-0 focus:ring-2 ring-blue-500" title="ì„¸í”¼ì•„"></button>
                        <button onclick="setTheme('theme-mint')" class="w-12 h-12 rounded-full border border-gray-300 shadow-sm bg-[#e0f2f1] flex-shrink-0 focus:ring-2 ring-blue-500" title="ë¯¼íŠ¸"></button>
                        <button onclick="setTheme('theme-dark')" class="w-12 h-12 rounded-full border border-gray-600 shadow-sm bg-[#1f2937] flex-shrink-0 focus:ring-2 ring-blue-500" title="ë‹¤í¬"></button>
                        <button onclick="setTheme('theme-black')" class="w-12 h-12 rounded-full border border-gray-700 shadow-sm bg-[#000000] flex-shrink-0 focus:ring-2 ring-blue-500" title="ë¸”ë™"></button>
                    </div>
                </div>

                <!-- í°íŠ¸ ë° í¬ê¸° -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">ê¸€ê¼´</label>
                        <div class="flex bg-current/5 rounded-lg p-1">
                            <button onclick="setFont('sans')" id="btn-font-sans" class="flex-1 py-2 rounded-md text-sm font-sans-kr transition-colors bg-white/90 text-black shadow-sm">ê³ ë”•</button>
                            <button onclick="setFont('serif')" id="btn-font-serif" class="flex-1 py-2 rounded-md text-sm font-serif-kr transition-colors opacity-60 hover:bg-white/50">ëª…ì¡°</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-bold opacity-70">ê¸€ì í¬ê¸° & ì¤„ ê°„ê²©</label>
                        <div class="flex items-center space-x-4">
                            <button onclick="adjustSize(-1)" class="w-10 h-10 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center text-lg">-</button>
                            <span id="font-size-display" class="font-mono w-12 text-center">18px</span>
                            <button onclick="adjustSize(1)" class="w-10 h-10 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center text-lg">+</button>
                            
                            <div class="h-8 w-px bg-current/20 mx-2"></div>

                            <button onclick="adjustLineHeight(-0.1)" class="w-10 h-10 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center text-sm" title="ì¤„ê°„ê²© ê°ì†Œ">ì¢ê²Œ</button>
                            <button onclick="adjustLineHeight(0.1)" class="w-10 h-10 rounded-full bg-current/10 hover:bg-current/20 flex items-center justify-center text-sm" title="ì¤„ê°„ê²© ì¦ê°€">ë„“ê²Œ</button>
                        </div>
                    </div>
                </div>

                <div class="pt-2 text-center">
                    <button onclick="toggleSettings()" class="text-sm opacity-50 hover:opacity-100 underline">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loader-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center space-y-4">
            <div class="loader"></div>
            <p class="text-gray-800 font-medium">íŒŒì¼ ì½ëŠ” ì¤‘...</p>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ
        const uploadScreen = document.getElementById('upload-screen');
        const viewerScreen = document.getElementById('viewer-screen');
        const fileInput = document.getElementById('file-input');
        const contentContainer = document.getElementById('content-container');
        const contentInner = document.getElementById('content-inner');
        const fileTitle = document.getElementById('file-title');
        const settingsPanel = document.getElementById('settings-panel');
        const progressBar = document.getElementById('progress-bar');
        const loaderOverlay = document.getElementById('loader-overlay');
        
        // ìƒíƒœ ë³€ìˆ˜
        let settings = {
            theme: 'theme-sepia',
            fontSize: 20,
            lineHeight: 1.8,
            fontFamily: 'sans' // 'sans' or 'serif'
        };
        let currentFile = null;

        // ì´ˆê¸°í™”
        function init() {
            loadSettings();
            applySettings();
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            uploadScreen.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadScreen.classList.add('bg-blue-500/10');
            });
            uploadScreen.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadScreen.classList.remove('bg-blue-500/10');
            });
            uploadScreen.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadScreen.classList.remove('bg-blue-500/10');
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFile(e.target.files[0]);
                }
            });

            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (ì§„í–‰ë¥  ë° ìë™ ì €ì¥)
            contentContainer.addEventListener('scroll', throttle(() => {
                updateProgress();
                saveProgress();
            }, 500));
            
            // ì„¤ì • í† ê¸€
            document.getElementById('settings-toggle').addEventListener('click', toggleSettings);
        }

        // íŒŒì¼ ì²˜ë¦¬
        function handleFile(file) {
            if (file.type && file.type.indexOf('text') === -1 && !file.name.endsWith('.txt')) {
                alert('TXT íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
                return;
            }

            loaderOverlay.classList.remove('hidden');
            const encoding = document.getElementById('encoding-select').value;
            const reader = new FileReader();

            reader.onload = (e) => {
                const text = e.target.result;
                renderText(text, file.name);
                loaderOverlay.classList.add('hidden');
                
                // ì´ì „ ì €ì¥ëœ ìœ„ì¹˜ê°€ ìˆëŠ”ì§€ í™•ì¸
                const savedScroll = localStorage.getItem(`scroll_${file.name}`);
                if (savedScroll) {
                    if(confirm("ì´ì „ì— ì½ë˜ ìœ„ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤. ì´ì–´ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        setTimeout(() => {
                            contentContainer.scrollTop = parseInt(savedScroll);
                        }, 100);
                    }
                }
            };

            reader.onerror = () => {
                alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                loaderOverlay.classList.add('hidden');
            };

            reader.readAsText(file, encoding);
        }

        function renderText(text, filename) {
            currentFile = filename;
            fileTitle.textContent = filename.replace('.txt', '');
            
            // HTML ì´ìŠ¤ì¼€ì´í”„ ë° ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            // ì„±ëŠ¥ì„ ìœ„í•´ DocumentFragment ì‚¬ìš©
            const fragment = document.createDocumentFragment();
            
            // í…ìŠ¤íŠ¸ ì •ì œ: ìºë¦¬ì§€ ë¦¬í„´ ì œê±°, ì—°ì†ëœ ê³µë°± ì²˜ë¦¬
            const lines = text.split(/\r?\n/);
            
            let buffer = [];
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.length > 0) {
                    const p = document.createElement('p');
                    p.textContent = trimmed; // textContentëŠ” ìë™ìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ë¨
                    fragment.appendChild(p);
                } else {
                    // ë¹ˆ ì¤„ì€ ì ì ˆí•œ ê°„ê²©ì„ ìœ„í•´ br í¬í•¨í•œ p ë˜ëŠ” ê·¸ëƒ¥ marginìœ¼ë¡œ ì²˜ë¦¬
                    // ì—¬ê¸°ì„œëŠ” ë¹ˆ P íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì‹œê°ì  ë¶„ë¦¬
                    const emptyP = document.createElement('p');
                    emptyP.innerHTML = '&nbsp;';
                    fragment.appendChild(emptyP);
                }
            });

            contentInner.innerHTML = '';
            contentInner.appendChild(fragment);

            // í™”ë©´ ì „í™˜
            uploadScreen.classList.add('hidden');
            viewerScreen.classList.remove('hidden');
        }

        function resetApp() {
            uploadScreen.classList.remove('hidden');
            viewerScreen.classList.add('hidden');
            fileInput.value = '';
            contentInner.innerHTML = '';
            currentFile = null;
            document.title = "ì›¹ì†Œì„¤ ë¦¬ë”";
        }

        // ì„¤ì • ê´€ë¦¬
        function toggleSettings() {
            settingsPanel.classList.toggle('panel-hidden');
            settingsPanel.classList.toggle('panel-visible');
        }

        function setTheme(themeName) {
            document.body.className = document.body.className.replace(/theme-\w+/, themeName);
            settings.theme = themeName;
            saveSettings();
        }

        function setFont(type) {
            settings.fontFamily = type;
            const sansBtn = document.getElementById('btn-font-sans');
            const serifBtn = document.getElementById('btn-font-serif');
            
            if (type === 'sans') {
                document.body.classList.remove('font-serif-kr');
                document.body.classList.add('font-sans-kr');
                
                sansBtn.classList.add('bg-white/90', 'text-black', 'shadow-sm');
                sansBtn.classList.remove('opacity-60', 'hover:bg-white/50');
                
                serifBtn.classList.remove('bg-white/90', 'text-black', 'shadow-sm');
                serifBtn.classList.add('opacity-60', 'hover:bg-white/50');
            } else {
                document.body.classList.remove('font-sans-kr');
                document.body.classList.add('font-serif-kr');
                
                serifBtn.classList.add('bg-white/90', 'text-black', 'shadow-sm');
                serifBtn.classList.remove('opacity-60', 'hover:bg-white/50');
                
                sansBtn.classList.remove('bg-white/90', 'text-black', 'shadow-sm');
                sansBtn.classList.add('opacity-60', 'hover:bg-white/50');
            }
            saveSettings();
        }

        function adjustSize(delta) {
            settings.fontSize = Math.max(12, Math.min(40, settings.fontSize + delta));
            applyStyleUpdates();
            saveSettings();
        }

        function adjustLineHeight(delta) {
            settings.lineHeight = Math.max(1.2, Math.min(3.0, settings.lineHeight + delta));
            // ì†Œìˆ˜ì  1ìë¦¬ë¡œ ì œí•œ
            settings.lineHeight = Math.round(settings.lineHeight * 10) / 10;
            applyStyleUpdates();
            saveSettings();
        }

        function applyStyleUpdates() {
            contentInner.style.fontSize = `${settings.fontSize}px`;
            contentInner.style.lineHeight = settings.lineHeight;
            document.getElementById('font-size-display').textContent = `${settings.fontSize}px`;
        }

        function applySettings() {
            setTheme(settings.theme);
            setFont(settings.fontFamily);
            applyStyleUpdates();
        }

        function saveSettings() {
            localStorage.setItem('webNovelReaderSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('webNovelReaderSettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
        }

        // ìœ í‹¸ë¦¬í‹°
        function updateProgress() {
            const scrollTop = contentContainer.scrollTop;
            const scrollHeight = contentContainer.scrollHeight - contentContainer.clientHeight;
            const percent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            progressBar.style.width = `${percent}%`;
        }

        function saveProgress() {
            if (currentFile) {
                localStorage.setItem(`scroll_${currentFile}`, contentContainer.scrollTop);
            }
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // ì•± ì‹œì‘
        init();

        // íƒ­í‚¤ ì ‘ê·¼ì„± ë° í‚¤ë³´ë“œ ì¡°ì‘
        document.addEventListener('keydown', (e) => {
            if (viewerScreen.classList.contains('hidden')) return;
            
            if (e.key === 'Escape') {
                if (settingsPanel.classList.contains('panel-visible')) {
                    toggleSettings();
                }
            }
        });
    </script>
</body>
</html>

